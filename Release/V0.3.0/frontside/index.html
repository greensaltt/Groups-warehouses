<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤æ‚Ÿ - é¦–é¡µ</title>
    <!-- <script src="./mock/indexMockData.js"></script> -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#22c55e',
                        secondary: '#f97316',
                        neutral: '#fdf5e6',
                        dark: '#1f2937'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral min-h-screen">
    <!-- å¤´éƒ¨åŒºåŸŸ -->
    <div class="header pt-6 pb-4 px-5">
        <div class="flex items-center">
            <h1 class="text-2xl font-bold text-dark">æˆ‘çš„èŠ±å›­</h1>
            <div class="decor-img ml-auto w-36 h-20 bg-[url('assets/images/å¤ªé˜³&æ¤ç‰©.png')] bg-contain bg-no-repeat bg-right"></div>
        </div>
    </div>

    <!-- æ™ºæ…§æé†’å¡ç‰‡ - ç»¿è‰²èƒŒæ™¯ -->
    <div class="reminder-card bg-[#5b8c5a] rounded-xl p-5 mx-5 mb-5">
        <h2 class="text-white text-lg font-semibold mb-4">æ™ºæ…§æé†’</h2>
        <div id="reminderContent" class="space-y-3">
            <!-- æé†’å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- æ¤ç‰©åˆ—è¡¨ -->
    <div class="plant-list grid grid-cols-2 gap-5 mx-5 mb-24">
        <!-- æ¤ç‰©å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- æ·»åŠ æŒ‰é’® - è·³è½¬è‡³my-plants.html -->
    <button class="add-btn fixed bottom-20 right-5 w-14 h-14 rounded-full bg-[#4CAF50] text-white text-2xl flex items-center justify-center hover:bg-[#45a049] transition-colors shadow-lg" onclick="window.location.href='my-plants.html'">+</button>

    <!-- å¯¼èˆªæ  -->
    <div class="nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200">
        <a href="index.html" class="nav-item active"><i class="fas fa-home nav-icon"></i>é¦–é¡µ</a>
        <a href="ai-assistant.html" class="nav-item"><i class="fas fa-comments nav-icon"></i>AIåŠ©æ‰‹</a>
        <a href="diary.html" class="nav-item"><i class="fas fa-seedling nav-icon"></i>æ—¥è®°</a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user nav-icon"></i>æˆ‘çš„</a>
    </div>

    <style>
        .nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        .nav-item {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .nav-item.active {
            color: #81c784;
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        .reminder-item {
            background: #d1e7d0;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .reminder-item p {
            text-sm text-dark;
        }
        /* è°ƒæ•´å‹¾é€‰æ¡†æ ·å¼ä¸ºåœ†å½¢å¼€å…³ */
        .check-toggle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #888;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .check-toggle.checked {
            background: #4CAF50;
            border-color: #4CAF50;
            color: white;
        }
        .plant-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px 0;
            color: #666;
        }
        .empty-state i {
            font-size: 40px;
            margin-bottom: 10px;
            color: #ccc;
        }
    </style>

    <script>
        // ============================================
        //  1. é…ç½®ä¸åŸºç¡€å‡½æ•°
        // ============================================

        // åç«¯åœ°å€
        const API_BASE_URL = 'http://127.0.0.1:8000/api/v1';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶è·å– Token
        function getAuthHeaders() {
            const token = localStorage.getItem('zhiwu_token');
            if (!token) {
                // æ²¡æœ‰ Tokenï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                window.location.href = 'login.html';
                return null;
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // é€šç”¨è¯·æ±‚å‡½æ•°
        async function request(endpoint, options = {}) {
            const headers = getAuthHeaders();
            if (!headers) return null;

            try {
                const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });

                // å¤„ç† Token è¿‡æœŸ
                if (res.status === 401) {
                    localStorage.removeItem('zhiwu_token');
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = 'login.html';
                    return null;
                }

                return await res.json();
            } catch (err) {
                console.error('APIè¯·æ±‚é”™è¯¯:', err);
                return null;
            }
        }

        // ============================================
        //  2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
        // ============================================

        // --- åŠ è½½æ¤ç‰©åˆ—è¡¨ (æ ¸å¿ƒä¿®æ”¹) ---
        async function loadPlants() {
            const plantListEl = document.querySelector('.plant-list');

            // è°ƒç”¨åç«¯æ¥å£
            const res = await request('/get_plants');

            // å¦‚æœè¯·æ±‚å¤±è´¥æˆ–æ•°æ®ä¸ºç©º
            if (!res || !res.data || res.data.length === 0) {
                renderEmptyState(plantListEl);
                return;
            }

            // æ¸²æŸ“åˆ—è¡¨
            renderPlantList(plantListEl, res.data);
            return res.data; // è¿”å›æ•°æ®ä¾›å¯èƒ½çš„ç­›é€‰ä½¿ç”¨
        }

        // æ¸²æŸ“â€œæš‚æ— æ¤ç‰©â€çŠ¶æ€
        function renderEmptyState(container) {
            container.innerHTML = `
                <div class="empty-state col-span-2 flex flex-col items-center justify-center py-10 text-gray-400">
                    <i class="bi bi-flower1" style="font-size: 40px; margin-bottom: 10px;"></i>
                    <p>æš‚æ— æ¤ç‰©ï¼Œå¿«å»æ·»åŠ å§</p>
                    <button class="mt-4 px-6 py-2 bg-[#8cb38a] text-white rounded-full text-sm hover:bg-[#7aa578] transition-colors" onclick="window.location.href='my-plants.html'">
                        å»æ·»åŠ 
                    </button>
                </div>
            `;
        }

        // æ¸²æŸ“æ¤ç‰©å¡ç‰‡åˆ—è¡¨
        function renderPlantList(container, plants) {
            container.innerHTML = plants.map(plant => {
                // --- è®¡ç®—ä¸‹æ¬¡æµ‡æ°´æ—¶é—´é€»è¾‘ ---
                let wateringText = "æš‚æ— è®°å½•";

                if (plant.last_watered) {
                    const lastDate = new Date(plant.last_watered);
                    const cycle = plant.water_cycle || 7;

                    // ä¸‹æ¬¡æµ‡æ°´æ—¥æœŸ = ä¸Šæ¬¡ + å‘¨æœŸ
                    const nextDate = new Date(lastDate);
                    nextDate.setDate(lastDate.getDate() + cycle);

                    // è®¡ç®—å·®è·å¤©æ•°
                    const today = new Date();
                    // é‡ç½®æ—¶åˆ†ç§’ï¼Œåªæ¯”è¾ƒæ—¥æœŸ
                    today.setHours(0,0,0,0);
                    nextDate.setHours(0,0,0,0);

                    const diffTime = nextDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        wateringText = `<span class="text-red-500 font-bold">å·²é€¾æœŸ ${Math.abs(diffDays)} å¤©</span>`;
                    } else if (diffDays === 0) {
                        wateringText = `<span class="text-orange-500 font-bold">ä»Šå¤©æµ‡æ°´</span>`;
                    } else {
                        wateringText = `è·ç¦»ä¸‹æ¬¡æµ‡æ°´è¿˜æœ‰ï¼š${diffDays}å¤©`;
                    }
                } else {
                    wateringText = "æ–°æ¤ç‰© (å»ºè®®æµ‡æ°´)";
                }

                // å¤„ç†å›¾ç‰‡ï¼šå¦‚æœåç«¯æ²¡å­˜å›¾ç‰‡URLï¼Œæš‚æ—¶ç”¨Emoji
                // ä½ åç»­å¯ä»¥æ‰©å±•åç«¯å­˜ imageUrl
                const imgHtml = `
                    <div class="w-full h-36 bg-green-50 rounded-lg mb-3 flex items-center justify-center text-6xl">
                        ${plant.icon || 'ğŸŒ±'}
                    </div>
                `;

                return `
                    <div class="plant-card bg-white rounded-xl p-4 flex flex-col items-center shadow-sm hover:shadow-md transition-shadow cursor-pointer" onclick="viewPlantDetail('${plant.id}')">
                        ${imgHtml}
                        <h3 class="text-base font-medium text-dark mb-1">${plant.nickname}</h3>
                        <p class="text-xs text-gray-500 mb-2">${plant.species}</p>
                        <p class="text-xs text-gray-600">${wateringText}</p>
                    </div>
                `;
            }).join('');
        }

        // --- åŠ è½½æ™ºæ…§æé†’ (ä¿æŒä¹‹å‰çš„é€»è¾‘) ---
        async function loadReminders() {
            const container = document.getElementById('reminderContent');
            const res = await request('/reminders');

            // å…¼å®¹ BaseResponse ç»“æ„ (res.data å¯èƒ½æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæˆ–è€…åŒ…å« reminders å­—æ®µ)
            const reminders = Array.isArray(res?.data) ? res.data : (res?.data?.reminders || []);

            if (reminders.length === 0) {
                container.innerHTML = `
                    <div class="text-white text-center opacity-90 py-4 flex flex-col items-center">
                        <i class="bi bi-check-circle text-2xl mb-2"></i>
                        <p class="text-sm">å¤ªæ£’äº†ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼</p>
                    </div>`;
                return;
            }

            container.innerHTML = reminders.map(item => `
                <div class="reminder-item" id="reminder-${item.plant_id}-${item.type}">
                    <div class="flex items-center flex-1">
                        <span class="mr-2 text-xl">${item.icon}</span>
                        <div>
                            <p class="font-medium text-gray-800">${item.message}</p>
                            <span class="text-xs ${getUrgencyColor(item.urgency)}">
                                ${item.type === 'water' ? 'éœ€æµ‡æ°´' : 'éœ€æ–½è‚¥'} Â· é€¾æœŸ${item.days_overdue}å¤©
                            </span>
                        </div>
                    </div>
                    <!-- æ‰“å¡æŒ‰é’® -->
                    <div class="check-toggle" onclick="completeTask(this, ${item.plant_id}, '${item.type}')">
                        <i class="fas fa-check text-white text-sm"></i>
                    </div>
                </div>
            `).join('');
        }

        function getUrgencyColor(urgency) {
            if (urgency === 'high') return 'text-red-500 font-bold';
            if (urgency === 'medium') return 'text-orange-500';
            return 'text-green-600';
        }

        // --- å®Œæˆæ‰“å¡ ---
        async function completeTask(btnElement, plantId, type) {
            if (btnElement.classList.contains('checked')) return;

            const res = await request(`/plants/${plantId}/${type}`, { method: 'POST' });

            if (res && res.code === 200) {
                btnElement.classList.add('checked');
                // åŠ¨ç”»æ•ˆæœ
                setTimeout(() => {
                    const row = document.getElementById(`reminder-${plantId}-${type}`);
                    if (row) {
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(20px)';
                        // åˆ·æ–°æ•°æ®ï¼šæé†’æ¶ˆå¤±ï¼Œæ¤ç‰©åˆ—è¡¨é‡Œçš„æ—¶é—´ä¹Ÿè¦æ›´æ–°
                        setTimeout(() => {
                            loadReminders();
                            loadPlants();
                        }, 500);
                    }
                }, 500);
            } else {
                alert(res?.msg || 'æ“ä½œå¤±è´¥');
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---

        // æŸ¥çœ‹è¯¦æƒ… (è·³è½¬æš‚æœªå®ç°ï¼Œå…ˆæ‰“å°)
        function viewPlantDetail(plantId) {
            // window.location.href = `plant-detail.html?id=${plantId}`;
            console.log("æŸ¥çœ‹æ¤ç‰©è¯¦æƒ…ID:", plantId);
        }

        // ç­›é€‰é€»è¾‘ (å‰ç«¯ç­›é€‰)
        function filterByLocation(location, btn) {
            // è¿™é‡Œä»…ä»…æ˜¯ UI åˆ‡æ¢ï¼Œå› ä¸ºåç«¯è¿˜æ²¡åŠ  Location å­—æ®µ
            // ä½ å¯ä»¥æŒ‰ç…§ä¹‹å‰ my-plants.html çš„é€»è¾‘åç»­å®Œå–„åç«¯
            document.querySelectorAll('.location-buttons button').forEach(b => {
                b.classList.remove('bg-[#7aa578]');
                b.classList.add('bg-[#8cb38a]');
            });
            if(btn) { // å¦‚æœæ˜¯ç‚¹å‡»è§¦å‘
                btn.classList.remove('bg-[#8cb38a]');
                btn.classList.add('bg-[#7aa578]');
            }
            console.log("æ­£åœ¨ç­›é€‰:", location);
            // é‡æ–°åŠ è½½æ‰€æœ‰ (ç”±äºæš‚æ— locationå­—æ®µï¼Œä¸åšå®é™…è¿‡æ»¤)
            loadPlants();
        }

        // åˆå§‹åŒ–å¯¼èˆªæ é«˜äº®
        function initNav() {
            const currentPath = window.location.pathname.split('/').pop() || 'index.html';
            const navLinks = document.querySelectorAll('.nav a');
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        // ============================================
        //  3. åˆå§‹åŒ–å…¥å£
        // ============================================
        async function init() {
            // éªŒè¯ç™»å½•
            if (!getAuthHeaders()) return;

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            const userStr = localStorage.getItem('zhiwu_user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    const welcomeEl = document.getElementById('welcomeUser');
                    if(welcomeEl) welcomeEl.textContent = `Hi, ${user.username || 'èŠ±å‹'}`;
                } catch(e) {}
            }

            // æ˜¾ç¤ºæ—¥æœŸ
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            const headerTitle = document.querySelector('.header h1');
            if (headerTitle) {
                 // ä¿æŒåŸæœ‰æ ‡é¢˜ï¼Œè¿½åŠ æ—¥æœŸ
                 headerTitle.innerHTML = `æˆ‘çš„èŠ±å›­ <span class="text-sm font-normal text-gray-500 ml-2">${dateStr}</span>`;
            }

            initNav();

            // å¹¶è¡ŒåŠ è½½æ•°æ®
            await Promise.all([
                loadReminders(),
                loadPlants()
            ]);
        }

        // å¯åŠ¨
        window.addEventListener('load', init);
    </script>
</body>
</html>