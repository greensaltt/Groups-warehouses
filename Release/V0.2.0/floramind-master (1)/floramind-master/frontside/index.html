<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤æ‚Ÿ - é¦–é¡µ</title>
    <!-- ç§»é™¤æ¨¡æ‹Ÿæ•°æ®å¼•ç”¨ï¼Œç›´æ¥å¯¹æ¥åç«¯ -->
    <!-- <script src="./mock/indexMockData.js"></script> -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#22c55e',
                        secondary: '#f97316',
                        neutral: '#fdf5e6',
                        dark: '#1f2937'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral min-h-screen">
    <!-- å¤´éƒ¨åŒºåŸŸ -->
    <div class="header pt-6 pb-4 px-5">
        <div class="flex items-center">
            <h1 class="text-2xl font-bold text-dark">æˆ‘çš„èŠ±å›­</h1>
            <!-- æ˜¾ç¤ºå½“å‰ç”¨æˆ· (å¯é€‰) -->
            <span id="welcomeUser" class="ml-2 text-sm text-gray-500"></span>
            <div class="decor-img ml-auto w-36 h-20 bg-[url('assets/images/å¤ªé˜³&æ¤ç‰©.png')] bg-contain bg-no-repeat bg-right"></div>
        </div>
    </div>

    <!-- æ™ºæ…§æé†’å¡ç‰‡ - ç»¿è‰²èƒŒæ™¯ -->
    <div class="reminder-card bg-[#5b8c5a] rounded-xl p-5 mx-5 mb-5 shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-white text-lg font-semibold">æ™ºæ…§æé†’</h2>
            <!-- æ·»åŠ åˆ·æ–°æŒ‰é’® -->
            <button onclick="init()" class="text-white opacity-80 hover:opacity-100">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div id="reminderContent" class="space-y-3 min-h-[60px]">
            <!-- æé†’å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            <div class="text-white text-center text-sm opacity-80 py-4">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- æ¤ç‰©ä½ç½®ç­›é€‰ (å‰ç«¯ç­›é€‰æš‚æ—¶ä¿ç•™ï¼Œå®é™…å¯å¯¹æ¥åç«¯ç­›é€‰) -->
    <div class="location-buttons flex gap-3 mx-5 mb-5 overflow-x-auto pb-2 no-scrollbar">
        <button class="px-5 py-2 bg-[#7aa578] text-white rounded-full text-sm whitespace-nowrap" onclick="filterByLocation('å…¨éƒ¨', this)">å…¨éƒ¨</button>
        <button class="px-5 py-2 bg-[#8cb38a] text-white rounded-full text-sm whitespace-nowrap" onclick="filterByLocation('å®¢å…', this)">å®¢å…</button>
        <button class="px-5 py-2 bg-[#8cb38a] text-white rounded-full text-sm whitespace-nowrap" onclick="filterByLocation('é˜³å°', this)">é˜³å°</button>
        <button class="px-5 py-2 bg-[#8cb38a] text-white rounded-full text-sm whitespace-nowrap" onclick="filterByLocation('ä¹¦æˆ¿', this)">ä¹¦æˆ¿</button>
    </div>

    <!-- æ¤ç‰©åˆ—è¡¨ -->
    <div class="plant-list grid grid-cols-2 gap-5 mx-5 mb-24">
        <!-- æ¤ç‰©å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- æ·»åŠ æŒ‰é’® -->
    <button class="add-btn fixed bottom-20 right-5 w-14 h-14 rounded-full bg-[#4CAF50] text-white text-2xl flex items-center justify-center hover:bg-[#45a049] transition-colors shadow-lg z-10" onclick="window.location.href='my-plants.html'">+</button>

    <!-- å¯¼èˆªæ  -->
    <div class="nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-10">
        <a href="index.html" class="nav-item active"><i class="fas fa-home nav-icon"></i>é¦–é¡µ</a>
        <a href="ai-assistant.html" class="nav-item"><i class="fas fa-comments nav-icon"></i>aiåŠ©æ‰‹</a>
        <a href="diary.html" class="nav-item"><i class="fas fa-seedling nav-icon"></i>æ¤ç‰©</a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user nav-icon"></i>æˆ‘çš„</a>
    </div>

    <style>
        .nav { display: flex; justify-content: space-around; padding: 10px 0; }
        .nav-item { text-decoration: none; color: #666; font-size: 14px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: #81c784; }
        .nav-icon { font-size: 20px; margin-bottom: 5px; }

        .reminder-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .reminder-item p { margin: 0; color: #333; font-size: 14px; flex: 1; margin-right: 10px; }

        /* å‹¾é€‰æ¡†æ ·å¼ */
        .check-toggle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #8cb38a;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .check-toggle:hover { border-color: #4CAF50; }
        .check-toggle.checked { background: #4CAF50; border-color: #4CAF50; color: white; }

        .empty-state { grid-column: 1 / -1; text-align: center; padding: 30px 0; color: #999; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <script>
        // ============================================
        //  é…ç½®ä¸åŸºç¡€å‡½æ•°
        // ============================================

        // æŒ‡å‘ä½ çš„æœ¬åœ°åç«¯åœ°å€
        const API_BASE_URL = 'http://127.0.0.1:8000/api/v1';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLogin() {
            const token = localStorage.getItem('zhiwu_token');
            if (!token) {
                // æ²¡æœ‰ Tokenï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                window.location.href = 'login.html';
                return null;
            }
            return token;
        }

        // é€šç”¨ API è¯·æ±‚å‡½æ•° (è‡ªåŠ¨å¸¦ Token)
        async function request(url, options = {}) {
            const token = checkLogin();
            if (!token) return;

            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // å…³é”®ï¼šå¸¦ä¸Š Token
            };

            try {
                const res = await fetch(`${API_BASE_URL}${url}`, {
                    ...options,
                    headers: { ...defaultHeaders, ...options.headers }
                });

                // å¤„ç† 401 Token è¿‡æœŸ
                if (res.status === 401) {
                    localStorage.removeItem('zhiwu_token');
                    localStorage.removeItem('zhiwu_user');
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = 'login.html';
                    return;
                }

                const data = await res.json();
                return data;

            } catch (err) {
                console.error('Request Error:', err);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨');
                return null;
            }
        }

        // ============================================
        //  ä¸šåŠ¡é€»è¾‘ï¼šè·å–æ•°æ®
        // ============================================

        // 1. è·å–å¹¶æ¸²æŸ“æ¤ç‰©åˆ—è¡¨
        async function loadPlants() {
            const plantListEl = document.querySelector('.plant-list');

            const res = await request('/plants'); // å‡è®¾ä½ æœ‰ GET /plants æ¥å£
            // å¦‚æœåç«¯æ²¡æœ‰è¿”å›æ•°æ®ç»“æ„ï¼Œæˆ–è€…æ˜¯ç©º
            if (!res || !res.data || res.data.length === 0) {
                plantListEl.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-flower1" style="font-size: 32px; margin-bottom: 8px; display:block;"></i>
                        <p>æš‚æ— æ¤ç‰©ï¼Œå¿«å»æ·»åŠ å§</p>
                    </div>`;
                return [];
            }

            const plants = res.data;
            // æ¸²æŸ“åˆ—è¡¨
            renderPlants(plants);
            return plants; // è¿”å›ä¾›ç­›é€‰ä½¿ç”¨
        }

        function renderPlants(plants) {
            const plantListEl = document.querySelector('.plant-list');
            plantListEl.innerHTML = plants.map(plant => `
                <div class="bg-white rounded-xl p-4 flex flex-col items-center shadow-sm hover:shadow-md transition-shadow cursor-pointer" onclick="window.location.href='plant-detail.html?id=${plant.id}'">
                    <!-- å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç”¨Emojiä»£æ›¿ -->
                    <div class="w-full h-32 bg-gray-100 rounded-lg mb-3 flex items-center justify-center text-6xl">
                        ${plant.icon || 'ğŸŒ±'}
                    </div>
                    <h3 class="text-base font-medium text-dark mb-1">${plant.nickname}</h3>
                    <p class="text-xs text-gray-500">${plant.species}</p>
                    <div class="mt-2 text-xs px-2 py-1 bg-green-100 text-green-700 rounded">
                        ${plant.water_cycle}å¤©ä¸€æµ‡
                    </div>
                </div>
            `).join('');
        }

        // 2. è·å–å¹¶æ¸²æŸ“æ™ºèƒ½æé†’
        async function loadReminders() {
            const container = document.getElementById('reminderContent');

            const res = await request('/reminders');

            // æ³¨æ„ï¼šæ ¹æ®ä¹‹å‰çš„åç«¯ä»£ç ï¼Œè¿”å›ç»“æ„æ˜¯ { data: { reminders: [], total: 0 } }
            // æˆ–è€… { data: [] } å–å†³äºä½ çš„ ReminderResponse å®šä¹‰
            // è¿™é‡Œå‡è®¾æ˜¯ res.data.reminders æˆ–è€… res.data (ç›´æ¥æ˜¯åˆ—è¡¨)
            const reminders = res?.data?.reminders || res?.data || [];

            if (reminders.length === 0) {
                container.innerHTML = `
                    <div class="text-white text-center opacity-90 py-4 flex flex-col items-center">
                        <i class="bi bi-check-circle text-2xl mb-2"></i>
                        <p class="text-sm">å¤ªæ£’äº†ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼</p>
                    </div>`;
                return;
            }

            container.innerHTML = reminders.map(item => `
                <div class="reminder-item" id="reminder-${item.plant_id}-${item.type}">
                    <div class="flex items-center flex-1">
                        <span class="mr-2 text-xl">${item.icon}</span>
                        <div>
                            <p class="font-medium text-gray-800">${item.message}</p>
                            <span class="text-xs ${getUrgencyColor(item.urgency)}">
                                ${item.type === 'water' ? 'éœ€æµ‡æ°´' : 'éœ€æ–½è‚¥'} Â· é€¾æœŸ${item.days_overdue}å¤©
                            </span>
                        </div>
                    </div>

                    <!-- æ‰“å¡æŒ‰é’® -->
                    <div class="check-toggle" onclick="completeTask(this, ${item.plant_id}, '${item.type}')">
                        <i class="fas fa-check text-white text-sm"></i>
                    </div>
                </div>
            `).join('');
        }

        function getUrgencyColor(urgency) {
            if (urgency === 'high') return 'text-red-500 font-bold';
            if (urgency === 'medium') return 'text-orange-500';
            return 'text-green-600';
        }

        // ============================================
        //  ä¸šåŠ¡é€»è¾‘ï¼šäº¤äº’æ“ä½œ
        // ============================================

        // å®Œæˆæ‰“å¡ (æ ¸å¿ƒåŠŸèƒ½)
        async function completeTask(btnElement, plantId, type) {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (btnElement.classList.contains('checked')) return;

            // 1. å‘é€è¯·æ±‚ç»™åç«¯
            // type å¯èƒ½æ˜¯ 'water' æˆ– 'fertilize'
            const res = await request(`/plants/${plantId}/${type}`, {
                method: 'POST'
            });

            if (res && res.code === 200) {
                // 2. å‰ç«¯UIåé¦ˆï¼šå˜ç»¿å¹¶æ‰“å‹¾
                btnElement.classList.add('checked');

                // 3. è§†è§‰ä¸Šæ·¡å‡ºæˆ–ç§»é™¤è¯¥è¡Œ (å»¶è¿Ÿä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°æ‰“é’©åŠ¨ç”»)
                setTimeout(() => {
                    const row = document.getElementById(`reminder-${plantId}-${type}`);
                    if (row) {
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(20px)';
                        // é‡æ–°åŠ è½½æé†’åˆ—è¡¨ä»¥ç¡®ä¿åŒæ­¥
                        setTimeout(loadReminders, 500);
                    }
                }, 500);
            } else {
                alert(res?.msg || 'æ“ä½œå¤±è´¥');
            }
        }

        // ç­›é€‰é€»è¾‘ (å‰ç«¯ç­›é€‰)
        let allPlantsCache = [];
        async function filterByLocation(location, btn) {
            // æ ·å¼åˆ‡æ¢
            document.querySelectorAll('.location-buttons button').forEach(b => {
                b.classList.remove('bg-[#7aa578]');
                b.classList.add('bg-[#8cb38a]');
            });
            btn.classList.remove('bg-[#8cb38a]');
            btn.classList.add('bg-[#7aa578]');

            // ç­›é€‰é€»è¾‘ (æ³¨ï¼šç”±äºç°åœ¨æ•°æ®åº“é‡Œå¯èƒ½æ²¡å­˜ location å­—æ®µï¼Œè¿™é‡Œæ¼”ç¤ºç”¨)
            // å¦‚æœä½ æƒ³çœŸæ­£å®ç°ï¼Œéœ€è¦åœ¨ Plant æ¨¡å‹é‡ŒåŠ  location å­—æ®µ
            if (location === 'å…¨éƒ¨') {
                renderPlants(allPlantsCache);
            } else {
                // ç®€å•æ¨¡æ‹Ÿï¼šå¦‚æœæ¤ç‰©æ•°æ®é‡Œæ²¡æœ‰ locationï¼Œè¿™ä¸ªç­›é€‰å¯èƒ½ä¸ºç©º
                // å»ºè®®åç»­ç»™ Plant æ¨¡å‹åŠ ä¸Š location å­—æ®µ
                const filtered = allPlantsCache.filter(p => p.location === location);
                renderPlants(filtered.length ? filtered : allPlantsCache); // å¦‚æœæ²¡æ•°æ®å±•ç¤ºå…¨éƒ¨ï¼Œé¿å…ç©ºç™½
            }
        }

        // ============================================
        //  åˆå§‹åŒ–
        // ============================================

        async function init() {
            // 1. éªŒè¯ç™»å½•
            if(!checkLogin()) return;

            // 2. æ˜¾ç¤ºç”¨æˆ·å
            const userStr = localStorage.getItem('zhiwu_user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    document.getElementById('welcomeUser').textContent = `Hi, ${user.username || 'èŠ±å‹'}`;
                } catch(e) {}
            }

            // 3. æ˜¾ç¤ºæ—¥æœŸ
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            document.querySelector('.header .text-2xl').innerHTML = `æˆ‘çš„èŠ±å›­ <span class="text-sm font-normal text-gray-500 ml-2">${dateStr}</span>`;

            // 4. åŠ è½½æ•°æ®
            loadReminders(); // åŠ è½½æé†’
            allPlantsCache = await loadPlants(); // åŠ è½½æ¤ç‰©åˆ—è¡¨
        }

        // é¡µé¢åŠ è½½å®Œæ¯•æ‰§è¡Œ
        window.addEventListener('load', init);

    </script>
</body>
</html>