<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤æ‚Ÿ - é¦–é¡µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#22c55e',
                        secondary: '#f97316',
                        neutral: '#fdf5e6',
                        dark: '#1f2937'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral min-h-screen pb-20">
    <!-- å¤´éƒ¨åŒºåŸŸ -->
    <div class="header pt-6 pb-4 px-5">
        <div class="flex items-center">
            <h1 class="text-2xl font-bold text-dark flex items-end">
                æˆ‘çš„èŠ±å›­
                <span id="welcomeUser" class="text-sm font-normal text-gray-500 ml-2 mb-1"></span>
            </h1>
            <div class="decor-img ml-auto w-36 h-20 bg-[url('assets/images/å¤ªé˜³&æ¤ç‰©.png')] bg-contain bg-no-repeat bg-right"></div>
        </div>
    </div>

    <!-- æ™ºæ…§æé†’å¡ç‰‡ -->
    <div class="reminder-card bg-[#5b8c5a] rounded-xl p-5 mx-5 mb-5 shadow-md relative overflow-hidden">
        <div class="absolute -right-5 -top-5 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
        <h2 class="text-white text-lg font-semibold mb-4 flex items-center">
            <i class="bi bi-stars mr-2"></i>æ™ºæ…§æé†’
        </h2>
        <div id="reminderContent" class="space-y-3 min-h-[50px]">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="text-white text-center opacity-80 py-2 text-sm">
                <i class="fas fa-spinner fa-spin mr-1"></i> æ­£åœ¨ç”Ÿæˆæ™ºèƒ½å»ºè®®...
            </div>
        </div>
    </div>

    <!-- æ¤ç‰©åˆ—è¡¨ -->
    <div class="px-5 mb-2 flex justify-between items-end">
        <h3 class="font-bold text-gray-700">æˆ‘çš„æ¤ç‰©</h3>
    </div>
    <div class="plant-list grid grid-cols-2 gap-4 mx-5 mb-24">
        <!-- æ¤ç‰©å¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- æ·»åŠ æŒ‰é’® -->
    <button class="add-btn fixed bottom-24 right-5 w-14 h-14 rounded-full bg-[#4CAF50] text-white text-3xl flex items-center justify-center hover:bg-[#45a049] transition-all shadow-lg active:scale-95 z-50" onclick="window.location.href='my-plants.html'">
        <i class="bi bi-plus"></i>
    </button>

    <!-- å¯¼èˆªæ  -->
    <div class="nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around py-2">
            <a href="index.html" class="nav-item active flex flex-col items-center text-[#2E8B57]">
                <i class="bi bi-house-door-fill text-xl mb-1"></i>
                <span class="text-xs">é¦–é¡µ</span>
            </a>
            <a href="ai-assistant.html" class="nav-item flex flex-col items-center text-gray-400 hover:text-[#2E8B57] transition-colors">
                <i class="bi bi-robot text-xl mb-1"></i>
                <span class="text-xs">AIåŠ©æ‰‹</span>
            </a>
            <a href="diary.html" class="nav-item flex flex-col items-center text-gray-400 hover:text-[#2E8B57] transition-colors">
                <i class="bi bi-journal-album text-xl mb-1"></i>
                <span class="text-xs">æ—¥è®°</span>
            </a>
            <a href="profile.html" class="nav-item flex flex-col items-center text-gray-400 hover:text-[#2E8B57] transition-colors">
                <i class="bi bi-person text-xl mb-1"></i>
                <span class="text-xs">æˆ‘çš„</span>
            </a>
        </div>
    </div>

    <script>
        // ============================================
        //  1. é…ç½®ä¸åŸºç¡€å‡½æ•°
        // ============================================

        const API_BASE_URL = 'http://127.0.0.1:8000/api/v1';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶è·å– Token
        function getAuthHeaders() {
            // ã€ä¿®æ­£1ã€‘è¿™é‡Œæ”¹å› 'token'ï¼Œä¸ login.html ä¿æŒä¸€è‡´
            const token = localStorage.getItem('zhiwu_token');
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        async function request(endpoint, options = {}) {
            const headers = getAuthHeaders();
            if (!headers) return null;

            try {
                // ã€æ³¨æ„ã€‘å¦‚æœä½ çš„åç«¯ reminder è·¯ç”±æœ‰å‰ç¼€ï¼Œè¯·åœ¨è¿™é‡Œè°ƒæ•´
                // ä¾‹å¦‚ï¼šå¦‚æœ endpoint æ˜¯ /reminders/get_plants
                const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });

                if (res.status === 401) {
                    localStorage.removeItem('token');
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = 'login.html';
                    return null;
                }

                return await res.json();
            } catch (err) {
                console.error('APIè¯·æ±‚é”™è¯¯:', err);
                return null;
            }
        }

        // ============================================
        //  2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
        // ============================================

        // --- åŠ è½½æ¤ç‰©åˆ—è¡¨ ---
        async function loadPlants() {
            const plantListEl = document.querySelector('.plant-list');

            // ã€æ³¨æ„ã€‘è¯·ç¡®ä¿åç«¯è·¯ç”±åœ°å€æ­£ç¡®ï¼Œè¿™é‡Œå‡è®¾æ˜¯ /get_plants
            const res = await request('/get_plants');

            if (!res || !res.data || res.data.length === 0) {
                renderEmptyState(plantListEl);
                return;
            }

            renderPlantList(plantListEl, res.data);
        }

        function renderEmptyState(container) {
            container.innerHTML = `
                <div class="col-span-2 flex flex-col items-center justify-center py-10 text-gray-400 bg-white/50 rounded-xl border-2 border-dashed border-gray-200">
                    <i class="bi bi-flower1 text-4xl mb-2 text-green-300"></i>
                    <p class="text-sm">æš‚æ— æ¤ç‰©</p>
                    <button class="mt-3 px-6 py-2 bg-[#8cb38a] text-white rounded-full text-xs hover:bg-[#7aa578] transition-colors" onclick="window.location.href='my-plants.html'">
                        å»æ·»åŠ ç¬¬ä¸€ç›†
                    </button>
                </div>
            `;
        }

        function renderPlantList(container, plants) {
            container.innerHTML = plants.map(plant => {
                // è®¡ç®—æµ‡æ°´çŠ¶æ€
                let wateringText = "æ–°æ¤ç‰©";
                let statusColor = "text-gray-500";

                if (plant.last_watered) {
                    const lastDate = new Date(plant.last_watered);
                    const cycle = plant.water_cycle || 7;
                    const nextDate = new Date(lastDate);
                    nextDate.setDate(lastDate.getDate() + cycle);

                    const today = new Date();
                    today.setHours(0,0,0,0);
                    nextDate.setHours(0,0,0,0);

                    const diffTime = nextDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        wateringText = `å·²é€¾æœŸ ${Math.abs(diffDays)} å¤©`;
                        statusColor = "text-red-500 font-bold";
                    } else if (diffDays === 0) {
                        wateringText = `ä»Šå¤©æµ‡æ°´`;
                        statusColor = "text-orange-500 font-bold";
                    } else {
                        wateringText = `${diffDays}å¤©åæµ‡æ°´`;
                        statusColor = "text-green-600";
                    }
                }

                // --- ä¿®æ”¹å›¾ç‰‡å¤„ç†é€»è¾‘ ---
                let mediaContent;
                const BASE_IMG_URL = 'http://127.0.0.1:8000/uploads/';

                if (plant.plantAvatar_url) {
                    // 2. å¤„ç†è·¯å¾„æ‹¼æ¥
                    // å¦‚æœæ•°æ®åº“é‡Œå­˜çš„æ˜¯å®Œæ•´ http å¼€å¤´çš„é“¾æ¥ï¼Œå°±ç›´æ¥ç”¨
                    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ (å¦‚ plantAvatars/xxx.jpg)ï¼Œå°±æ‹¼æ¥ä¸Šå‰ç¼€
                    let finalUrl = plant.plantAvatar_url;
                    if (!finalUrl.startsWith('http')) {
                        // å¤„ç† Windows å¯èƒ½äº§ç”Ÿçš„åæ–œæ é—®é¢˜
                        finalUrl = BASE_IMG_URL + finalUrl.replace(/\\/g, '/');
                    }

                    mediaContent = `
                        <img src="${finalUrl}"
                             alt="${plant.nickname}"
                             class="w-full h-32 object-cover rounded-lg mb-3 shadow-sm"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <!-- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ˜¾ç¤º -->
                        <div class="w-full h-32 bg-green-50 rounded-lg mb-3 items-center justify-center text-green-300 hidden">
                            <i class="bi bi-image text-4xl"></i>
                        </div>
                    `;
                } else {
                    // æ²¡æœ‰å›¾ç‰‡æ—¶çš„é»˜è®¤ Emoji
                    const icon = plant.icon || 'ğŸŒ±';
                    mediaContent = `
                        <div class="w-full h-32 bg-gradient-to-br from-green-50 to-orange-50 rounded-lg mb-3 flex items-center justify-center text-5xl shadow-inner">
                            ${icon}
                        </div>
                    `;
                }

                return `
                    <div class="plant-card bg-white rounded-xl p-4 flex flex-col items-center shadow-sm hover:shadow-md transition-all cursor-pointer group" onclick="console.log('ç‚¹å‡»æ¤ç‰©:${plant.id}')">
                        <div class="w-full overflow-hidden rounded-lg">
                            ${mediaContent}
                        </div>
                        <h3 class="text-sm font-bold text-dark mb-1 truncate w-full text-center mt-1">${plant.nickname}</h3>
                        <p class="text-xs ${statusColor}">${wateringText}</p>
                    </div>
                `;
            }).join('');
        }

        // --- åŠ è½½æ™ºæ…§æé†’ ---
        async function loadReminders() {
            const container = document.getElementById('reminderContent');
            const res = await request('/reminders'); // ç¡®è®¤åç«¯è·¯ç”±

            const reminders = Array.isArray(res?.data) ? res.data : (res?.data?.reminders || []);

            if (reminders.length === 0) {
                container.innerHTML = `
                    <div class="text-white text-center opacity-90 py-4 flex flex-col items-center">
                        <i class="bi bi-emoji-smile text-3xl mb-2"></i>
                        <p class="text-sm">ä»Šå¤©æ²¡æœ‰ä»»åŠ¡ï¼Œæ¤ç‰©ä»¬éƒ½å¾ˆå¥åº·ï¼</p>
                    </div>`;
                return;
            }

            container.innerHTML = reminders.map(item => `
                <div class="reminder-item flex items-start py-3 bg-white/90 backdrop-blur-sm rounded-lg p-3 mb-2 shadow-sm border-l-4 ${getUrgencyBorder(item.urgency)}" id="reminder-${item.plant_id}-${item.type}">
                    <!-- å·¦ä¾§ï¼šå†…å®¹åŒºåŸŸ -->
                    <div class="flex-1 min-w-0">
                        <!-- æ ‡é¢˜è¡Œ -->
                        <div class="flex items-center mb-1 flex-wrap gap-2">
                            <span class="text-sm font-bold text-gray-800">
                                ${item.message}
                            </span>
                            <span class="text-[10px] px-1.5 py-0.5 rounded border ${getUrgencyBadge(item.urgency)}">
                                ${item.type === 'water' ? 'æµ‡æ°´' : 'æ–½è‚¥'}
                            </span>
                        </div>

                        <!-- AI æ‹ŸäººåŒ–æ–‡æ¡ˆ -->
                        <div class="bg-green-50/80 rounded p-2 mt-1 relative">
                            <div class="flex gap-2">
                                <div class="mt-0.5"><i class="bi bi-robot text-[#3a633a] text-xs"></i></div>
                                <p class="text-xs text-[#3a633a] italic leading-relaxed">
                                    "${item.ai_message || 'ä¸»äººï¼Œåˆ«å¿˜äº†æˆ‘å“¦~'}"
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šæ‰“å¡æŒ‰é’® -->
                    <div class="check-toggle group ml-3 mt-1 w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center cursor-pointer hover:border-green-500 hover:bg-green-500 transition-all flex-shrink-0" onclick="completeTask(this, ${item.plant_id}, '${item.type}')">
                        <i class="fas fa-check text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                    </div>
                </div>
            `).join('');
        }

        function getUrgencyBorder(urgency) {
            if (urgency === 'high') return 'border-red-400';
            if (urgency === 'medium') return 'border-orange-400';
            return 'border-green-400';
        }

        function getUrgencyBadge(urgency) {
            if (urgency === 'high') return 'bg-red-50 text-red-600 border-red-200';
            if (urgency === 'medium') return 'bg-orange-50 text-orange-600 border-orange-200';
            return 'bg-green-50 text-green-600 border-green-200';
        }

        // --- å®Œæˆæ‰“å¡ ---
        async function completeTask(btnElement, plantId, type) {
            if (btnElement.classList.contains('bg-green-500')) return;

            // ä¹è§‚ UI æ›´æ–°
            btnElement.classList.add('bg-green-500', 'border-green-500');
            btnElement.querySelector('i').classList.remove('opacity-0');

            // è¯·æ±‚åç«¯
            const res = await request(`/plants/${plantId}/${type}`, { method: 'POST' });

            if (res && res.code === 200) {
                // æˆåŠŸï¼šç§»é™¤å¡ç‰‡åŠ¨ç”»
                setTimeout(() => {
                    const row = document.getElementById(`reminder-${plantId}-${type}`);
                    if (row) {
                        row.style.transition = 'all 0.5s';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(50px)';
                        // åˆ·æ–°æ•°æ®
                        setTimeout(() => {
                            loadReminders(); // åˆ·æ–°æ™ºæ…§æé†’åŒº
                            loadPlants();    // åˆ·æ–°æ¤ç‰©åˆ—è¡¨çš„æ—¶é—´çŠ¶æ€
                        }, 500);
                    }
                }, 300);
            } else {
                // å¤±è´¥ï¼šå›æ»šçŠ¶æ€
                btnElement.classList.remove('bg-green-500', 'border-green-500');
                btnElement.querySelector('i').classList.add('opacity-0');
                alert(res?.msg || 'æ“ä½œå¤±è´¥');
            }
        }

        // ============================================
        //  3. åˆå§‹åŒ–å…¥å£
        // ============================================
        async function init() {
            if (!getAuthHeaders()) return;

            // æ˜¾ç¤ºç”¨æˆ·å
            const userStr = localStorage.getItem('zhiwu_user'); // è¿™é‡Œå¯èƒ½æ˜¯ä¹‹å‰çš„é€»è¾‘å­˜çš„
            // æˆ–è€…å°è¯•ä» localStorage è§£æ token (JWT) è·å–ç”¨æˆ·åï¼Œæˆ–è€…ä¸“é—¨è°ƒä¸€ä¸ª /me æ¥å£
            // ç®€å•å¤„ç†ï¼šå¦‚æœ userStr å­˜åœ¨å°±ç”¨ï¼Œä¸å­˜åœ¨å°±æ˜¾ç¤ºé»˜è®¤
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    document.getElementById('welcomeUser').textContent = `Hi, ${user.username || 'èŠ±å‹'}`;
                } catch(e) {}
            }

            // å¹¶è¡ŒåŠ è½½
            await Promise.all([
                loadPlants(),
                loadReminders()
            ]);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>