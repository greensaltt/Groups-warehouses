<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>植悟 - AI养护助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Markdown 渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2E7D32',
                        secondary: '#81C784',
                        neutral: '#F1F8E9',
                        dark: '#1B5E20',
                    }
                }
            }
        }
    </script>
    <style>
        .chat-bubble-ai {
            background-color: #FFFFFF;
            border: 1px solid #E8F5E9;
            border-radius: 18px 18px 18px 0;
            padding: 12px 16px;
            max-width: 80%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .chat-bubble-user {
            background-color: #81C784;
            color: #FFFFFF;
            border-radius: 18px 18px 0 18px;
            padding: 12px 16px;
            max-width: 80%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #F1F8E9;
        }
        ::-webkit-scrollbar-thumb {
            background: #C8E6C9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #81C784;
        }
        /* 底部导航样式 */
        .nav {
            display: flex;
            justify-content: space-around;
            background-color: white;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid #eee;
            z-index: 1000;
        }
        .nav-item {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .nav-item.active {
            color: #81c784;
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        /* Markdown 样式 */
        .markdown-content {
            color: #333;
            line-height: 1.6;
        }
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: #1B5E20;
        }
        .markdown-content h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #81C784;
            padding-bottom: 0.3em;
        }
        .markdown-content h2 {
            font-size: 1.3em;
            border-bottom: 1px solid #C8E6C9;
            padding-bottom: 0.3em;
        }
        .markdown-content h3 {
            font-size: 1.1em;
        }
        .markdown-content p {
            margin: 0.5em 0;
        }
        .markdown-content ul,
        .markdown-content ol {
            margin: 0.5em 0;
            padding-left: 2em;
        }
        .markdown-content li {
            margin: 0.25em 0;
        }
        .markdown-content code {
            background-color: #F1F8E9;
            color: #2E7D32;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        .markdown-content pre {
            background-color: #F1F8E9;
            border: 1px solid #C8E6C9;
            border-radius: 8px;
            padding: 12px;
            overflow-x: auto;
            margin: 0.5em 0;
        }
        .markdown-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }
        .markdown-content blockquote {
            border-left: 4px solid #81C784;
            padding-left: 1em;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        .markdown-content a {
            color: #2E7D32;
            text-decoration: underline;
        }
        .markdown-content a:hover {
            color: #1B5E20;
        }
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5em 0;
            border: 1px solid #C8E6C9;
        }
        .markdown-content th,
        .markdown-content td {
            border: 1px solid #C8E6C9;
            padding: 8px 12px;
            text-align: left;
        }
        .markdown-content th {
            background-color: #E8F5E9;
            font-weight: 600;
            color: #1B5E20;
        }
        .markdown-content hr {
            border: none;
            border-top: 2px solid #C8E6C9;
            margin: 1em 0;
        }
        .markdown-content strong {
            color: #1B5E20;
            font-weight: 600;
        }
        .markdown-content em {
            color: #2E7D32;
            font-style: italic;
        }
        /* 防止按钮默认行为 */
        button:focus {
            outline: none;
        }
        /* 消息加载动画 */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #81C784;
            border-radius: 50%;
            animation: typingAnimation 1.5s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        /* 固定布局样式 */
        .main-container {
            display: flex;
            height: calc(100vh - 120px); /* 减去顶部导航和底部导航的高度 */
            gap: 20px;
            padding: 20px;
            margin-top: 70px; /* 为顶部导航留出空间 */
        }

        /* 历史对话区域 */
        .history-panel {
            width: 400px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .history-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* 对话区域 */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-input-area {
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            background-color: white;
        }

        /* 历史对话项样式 */
        .history-item {
            padding: 12px 16px;
            background-color: #F9F9F9;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e5e7eb;
        }

        .history-item:hover {
            background-color: #E8F5E9;
            border-color: #81C784;
            transform: translateY(-2px);
        }

        .history-item.active {
            background-color: #E8F5E9;
            border: 2px solid #2E7D32;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
        }

        /* 手机端隐藏历史面板 */
        @media (max-width: 768px) {
            .history-panel {
                display: none;
            }
            .main-container {
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 120px);
            }
            .chat-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-neutral min-h-screen">
    <!-- 顶部导航 -->
    <nav class="bg-primary text-white shadow-md fixed top-0 left-0 right-0 z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="hover:text-secondary transition-colors">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-xl font-bold flex items-center">
                <i class="fas fa-leaf mr-2"></i> 植物养护助手
            </h1>
            <div class="w-8"></div> <!-- 占位，保持导航对称 -->
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="main-container">
        <!-- 左侧：扩大的历史对话区域 -->
        <div class="history-panel">
            <div class="history-header">
                <h2 class="text-xl font-semibold text-dark mb-3 flex items-center">
                    <i class="fas fa-clock text-primary mr-3"></i> 历史对话记录
                </h2>
                <div class="relative mb-2">
                    <input type="text" id="historySearch" placeholder="搜索历史对话..."
                        class="w-full border border-gray-200 rounded-lg px-4 py-2 pl-10 outline-none focus:border-primary transition-colors text-sm">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="history-content" id="historyConversations">
                <div class="text-center text-sm text-gray-500 py-8">
                    暂无历史对话
                </div>
            </div>
        </div>

        <!-- 右侧：对话区域 -->
        <div class="chat-panel">
            <div class="chat-messages" id="chatContent">
                <!-- 欢迎消息 -->
                <div class="flex mb-6">
                    <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <i class="fas fa-robot text-primary"></i>
                    </div>
                    <div class="chat-bubble-ai">
                        <p class="text-gray-800">
                            你好呀！我是你的植物养护助手小植～ 有任何养护问题都可以问我哦！
                        </p>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('多肉叶子发黄怎么办？')">
                                多肉叶子发黄怎么办？
                            </button>
                            <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('绿萝多久浇一次水？')">
                                绿萝多久浇一次水？
                            </button>
                            <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('室内植物需要晒太阳吗？')">
                                室内植物需要晒太阳吗？
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 底部：输入框 -->
            <div class="chat-input-area">
                <div class="flex items-center mb-3">
                    <!-- 选择植物按钮 -->
                    <button type="button" id="selectPlantBtn" class="text-gray-500 hover:text-primary transition-colors p-2">
                        <i class="fas fa-leaf text-xl"></i>
                    </button>
                    <div class="ml-auto flex gap-2">
                        <button type="button" id="clearChatBtn" class="text-gray-500 hover:text-red-500 transition-colors text-sm">
                            新建对话
                        </button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="输入你的植物养护问题..."
                        class="flex-1 border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-primary transition-colors">
                    <button type="button" id="sendBtn" class="bg-primary text-white rounded-lg px-4 hover:bg-dark transition-colors">
                        发送
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="nav">
        <a href="index.html" class="nav-item"><i class="fas fa-home nav-icon"></i>首页</a>
        <a href="ai-assistant.html" class="nav-item active"><i class="fas fa-comments nav-icon"></i>AI助手</a>
        <a href="diary.html" class="nav-item"><i class="fas fa-seedling nav-icon"></i>日记</a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user nav-icon"></i>我的</a>
    </div>

    <script>
        // 配置后端API地址
        const API_BASE_URL = 'http://127.0.0.1:8000/api/v1/plant';

        // 全局变量
        let currentConversationId = '';
        let isSending = false;

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化...');

            // 加载历史对话
            loadHistoryConversations();
            // 调整面板高度
            adjustPanelsHeight();
            // 绑定事件
            bindEvents();

            // 监听窗口大小变化
            window.addEventListener('resize', adjustPanelsHeight);

            // 初始滚动到底部
            setTimeout(scrollChatToBottom, 100);

            console.log('初始化完成');
        });

        // 调整两个面板的高度对齐
        function adjustPanelsHeight() {
            const chatPanel = document.querySelector('.chat-panel');
            const historyPanel = document.querySelector('.history-panel');

            if (chatPanel && historyPanel && window.innerWidth > 768) {
                const chatHeight = chatPanel.offsetHeight;
                historyPanel.style.height = `${chatHeight}px`;
            }
        }

        // 绑定所有事件
        function bindEvents() {
            console.log('绑定事件...');

            // 发送消息按钮
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.addEventListener('click', (e) => {
                    console.log('发送按钮被点击');
                    e.preventDefault();
                    sendMessage();
                });
            }

            // 输入框回车发送
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        console.log('回车键被按下');
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // 清空对话按钮
            const clearChatBtn = document.getElementById('clearChatBtn');
            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (confirm('确定新建对话吗？当前对话历史将不会被保存。')) {
                        resetChat();
                    }
                });
            }

            // 选择植物按钮
            const selectPlantBtn = document.getElementById('selectPlantBtn');
            if (selectPlantBtn) {
                selectPlantBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectPlant();
                });
            }

            // 历史对话搜索
            const historySearch = document.getElementById('historySearch');
            if (historySearch) {
                historySearch.addEventListener('input', (e) => {
                    filterHistoryList(e.target.value);
                });
            }

            console.log('事件绑定完成');
        }

        // 重置聊天
        function resetChat() {
            const chatContent = document.getElementById('chatContent');
            if (chatContent) {
                chatContent.innerHTML = '';
                // 重新添加欢迎消息
                const welcomeMsg = `
                    <div class="flex mb-6">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                        <div class="chat-bubble-ai">
                            <p class="text-gray-800">
                                你好呀！我是你的植物养护助手小植～ 有任何养护问题都可以问我哦！
                            </p>
                            <div class="mt-2 flex flex-wrap gap-2">
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('多肉叶子发黄怎么办？')">
                                    多肉叶子发黄怎么办？
                                </button>
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('绿萝多久浇一次水？')">
                                    绿萝多久浇一次水？
                                </button>
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('室内植物需要晒太阳吗？')">
                                    室内植物需要晒太阳吗？
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                chatContent.insertAdjacentHTML('beforeend', welcomeMsg);
                currentConversationId = '';

                // 更新历史对话列表
                loadHistoryConversations();

                // 滚动到底部
                setTimeout(scrollChatToBottom, 100);
            }
        }

        // 选择植物
        function selectPlant() {
            const plants = getPlants();
            if (plants.length === 0) {
                alert('你还没有添加植物，快去添加植物档案吧～');
                return;
            }

            let plantOptions = '请选择要咨询的植物：\n';
            plants.forEach((plant, idx) => {
                plantOptions += `${idx + 1}. ${plant.nickname}（${plant.species}）\n`;
            });

            const selectedIdx = prompt(plantOptions);
            if (!selectedIdx || isNaN(selectedIdx) || selectedIdx < 1 || selectedIdx > plants.length) {
                return;
            }

            const selectedPlant = plants[selectedIdx - 1];
            document.getElementById('chatInput').value = `我想咨询${selectedPlant.nickname}（${selectedPlant.species}）的养护问题：`;
            document.getElementById('chatInput').focus();
        }

        // 发送示例问题
        function sendSampleQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        // 发送消息
        async function sendMessage() {
            console.log('开始发送消息...');

            // 防止重复发送
            if (isSending) {
                console.log('正在发送中，请稍候...');
                return;
            }

            const input = document.getElementById('chatInput');
            const message = input ? input.value.trim() : '';

            // 检查是否有内容
            if (!message) {
                alert('请输入问题');
                return;
            }

            isSending = true;

            try {
                // 添加用户消息到对话
                addMessageToChat('user', message);

                // 清空输入框
                if (input) {
                    input.value = '';
                }

                // 生成AI回复
                await generateAiReply(message);

            } catch (error) {
                console.error('发送消息失败:', error);
                addMessageToChat('ai', `抱歉，发送消息时出现错误：${error.message}`);
            } finally {
                isSending = false;
                console.log('发送完成，重置发送状态');
            }
        }

        // 添加消息到对话界面
        function addMessageToChat(type, content) {
            const chatContent = document.getElementById('chatContent');
            if (!chatContent) {
                console.error('找不到聊天内容容器');
                return;
            }

            let msgHtml = '';
            const timestamp = new Date().toLocaleTimeString();

            if (type === 'user') {
                let contentHtml = '';

                // 添加文字内容
                if (content && content.trim()) {
                    contentHtml += `<p>${escapeHtml(content)}</p>`;
                }

                // 添加时间戳
                contentHtml += `<div class="text-xs text-white/80 mt-1 text-right">${timestamp}</div>`;

                msgHtml = `
                    <div class="flex mb-6 justify-end">
                        <div class="chat-bubble-user">
                            ${contentHtml}
                        </div>
                        <div class="w-10 h-10 bg-secondary/20 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </div>
                `;
            } else if (type === 'ai') {
                // 使用 marked 渲染 Markdown
                const markdownHtml = renderMarkdown(content);

                // 添加时间戳
                const contentWithTime = markdownHtml + `<div class="text-xs text-gray-500 mt-2">${timestamp}</div>`;

                msgHtml = `
                    <div class="flex mb-6">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                        <div class="chat-bubble-ai">
                            <div class="text-gray-800 markdown-content">${contentWithTime}</div>
                        </div>
                    </div>
                `;
            } else if (type === 'loading') {
                msgHtml = `
                    <div class="flex mb-6">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                        <div class="chat-bubble-ai">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <span class="ml-2 text-gray-600">小植正在思考中...</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            chatContent.insertAdjacentHTML('beforeend', msgHtml);
            // 滚动到底部
            setTimeout(scrollChatToBottom, 10);
        }

        // 滚动聊天区域到底部
        function scrollChatToBottom() {
            const chatContent = document.getElementById('chatContent');
            if (chatContent) {
                chatContent.scrollTo({
                    top: chatContent.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        // 生成AI回复
        async function generateAiReply(question) {
            console.log('开始生成AI回复，问题:', question);

            // 显示加载状态
            addMessageToChat('loading', '');

            try {
                // 构建FormData
                const formData = new FormData();

                // 添加文字问题
                if (question && question.trim()) {
                    formData.append('message', question);
                }

                // 如果有对话ID
                if (currentConversationId) {
                    formData.append('conversation_id', currentConversationId);
                    console.log('使用对话ID:', currentConversationId);
                }

                console.log('发送请求到:', `${API_BASE_URL}/chat`);

                // 发送请求
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    body: formData
                });

                console.log('响应状态:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMsg = `请求失败! 状态码: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.detail || errorData.message || errorMsg;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMsg = errorText || errorMsg;
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                console.log('API响应数据:', data);

                if (data.success) {
                    // 更新对话ID
                    if (data.conversation_id) {
                        currentConversationId = data.conversation_id;
                        console.log('新对话ID:', currentConversationId);
                    }

                    // 移除加载消息
                    removeLastMessage();

                    // 添加真实回复
                    if (data.message) {
                        addMessageToChat('ai', data.message);
                    } else {
                        addMessageToChat('ai', '抱歉，没有收到有效的回复，请重试。');
                    }

                    // 刷新历史对话列表
                    loadHistoryConversations();

                } else {
                    throw new Error(data.error || 'API返回失败');
                }

            } catch (error) {
                console.error('AI回复生成失败:', error);
                // 移除加载消息
                removeLastMessage();
                // 显示错误信息
                const errorMessage = `抱歉，AI助手暂时无法响应。<br>错误信息：${escapeHtml(error.message)}<br>请稍后重试或联系管理员。`;
                addMessageToChat('ai', errorMessage);
            }
        }

        // 移除最后一条消息
        function removeLastMessage() {
            const chatContent = document.getElementById('chatContent');
            if (!chatContent) return;

            const messages = chatContent.querySelectorAll('.flex.mb-6');
            if (messages.length > 0) {
                messages[messages.length - 1].remove();
            }
        }

        // 加载历史对话
        async function loadHistoryConversations() {
            try {
                console.log('开始加载历史对话...');
                const response = await fetch(`${API_BASE_URL}/conversations`);

                if (!response.ok) {
                    console.warn('历史对话API请求失败:', response.status);
                    return;
                }

                const data = await response.json();
                console.log('历史对话数据:', data);

                const historyContainer = document.getElementById('historyConversations');
                if (!historyContainer) return;

                if (!data.conversations || data.conversations.length === 0) {
                    historyContainer.innerHTML = '<div class="text-center text-sm text-gray-500 py-8">暂无历史对话</div>';
                    return;
                }

                historyContainer.innerHTML = data.conversations.map(conv => {
                    const date = new Date(conv.created_at);
                    const dateStr = `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    const isActive = conv.id === currentConversationId;

                    return `
                        <div class="history-item ${isActive ? 'active' : ''}" onclick="loadConversation('${conv.id}')">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="text-sm font-medium text-dark truncate flex-1 mr-2">${conv.title || '无标题对话'}</h3>
                                <span class="text-xs text-gray-500 shrink-0">${dateStr}</span>
                            </div>
                            <p class="text-xs text-gray-500 truncate">${conv.last_message || '暂无消息内容'}</p>
                            <div class="mt-1 flex justify-between items-center">
                                <span class="text-xs text-gray-400">${conv.message_count || 0} 条消息</span>
                                <button onclick="deleteConversation('${conv.id}', event)" class="text-xs text-gray-400 hover:text-red-500">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // 调整面板高度
                setTimeout(adjustPanelsHeight, 100);
            } catch (error) {
                console.error('加载历史对话失败:', error);
            }
        }

        // 删除对话
        async function deleteConversation(convId, event) {
            event.stopPropagation();

            if (!confirm('确定删除这个对话吗？删除后将无法恢复。')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/conversations/${convId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // 如果是当前对话，重置聊天
                    if (currentConversationId === convId) {
                        resetChat();
                    }
                    // 重新加载历史对话列表
                    loadHistoryConversations();
                }
            } catch (error) {
                console.error('删除对话失败:', error);
                alert('删除对话失败，请稍后重试');
            }
        }

        // 加载特定对话
        async function loadConversation(convId) {
            try {
                console.log('加载对话:', convId);
                const response = await fetch(`${API_BASE_URL}/conversations/${convId}`);

                if (!response.ok) {
                    throw new Error(`加载失败: ${response.status}`);
                }

                const conv = await response.json();
                if (!conv) return;

                // 清空当前对话
                const chatContent = document.getElementById('chatContent');
                if (chatContent) {
                    chatContent.innerHTML = '';
                }

                currentConversationId = convId;

                // 加载对话历史
                if (conv.messages && conv.messages.length > 0) {
                    for (let i = 0; i < conv.messages.length; i++) {
                        const msg = conv.messages[i];
                        await new Promise(resolve => setTimeout(resolve, 100));

                        if (msg.role === 'user') {
                            addMessageToChat('user', msg.content);
                        } else if (msg.role === 'assistant') {
                            addMessageToChat('ai', msg.content);
                        }
                    }
                }

                // 刷新历史对话列表
                loadHistoryConversations();

                // 滚动到底部
                setTimeout(scrollChatToBottom, 200);

            } catch (error) {
                console.error('加载对话失败:', error);
                alert('加载对话失败：' + error.message);
            }
        }

        // 筛选历史对话列表
        function filterHistoryList(keyword) {
            const list = document.getElementById('historyConversations');
            if (!list) return;

            const items = list.querySelectorAll('.history-item');
            keyword = keyword.toLowerCase();

            items.forEach(item => {
                const title = item.querySelector('h3')?.textContent.toLowerCase() || '';
                const content = item.querySelector('p')?.textContent.toLowerCase() || '';
                const text = title + ' ' + content;
                item.style.display = text.includes(keyword) ? '' : 'none';
            });
        }

        // 获取用户添加的植物列表
        function getPlants() {
            try {
                const plants = localStorage.getItem('zhiwu_plants');
                return plants ? JSON.parse(plants) : [];
            } catch (e) {
                console.error('读取植物列表失败:', e);
                return [];
            }
        }

        // Markdown渲染函数
        function renderMarkdown(text) {
            if (!text) return '';

            try {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    pedantic: false,
                    sanitize: false,
                });

                let html = marked.parse(text);

                // 高亮代码块
                const codeBlocks = html.match(/<pre><code[^>]*>([^<]+)<\/code><\/pre>/g);
                if (codeBlocks) {
                    codeBlocks.forEach(block => {
                        try {
                            const code = block.replace(/<[^>]+>/g, '').trim();
                            const language = block.match(/language-([^"'\s>]+)/);
                            const lang = language ? language[1] : 'plaintext';

                            let highlighted = code;
                            if (hljs && hljs.getLanguage(lang)) {
                                highlighted = hljs.highlight(code, { language: lang }).value;
                            } else {
                                highlighted = hljs ? hljs.highlight(code, { language: 'plaintext' }).value : code;
                            }

                            html = html.replace(block, `<pre><code class="hljs language-${lang}">${highlighted}</code></pre>`);
                        } catch (e) {
                            console.warn('代码高亮失败:', e);
                        }
                    });
                }

                return html;
            } catch (e) {
                console.error('Markdown渲染失败:', e);
                return text;
            }
        }

        // HTML转义函数
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>