<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>植悟 - AI养护助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Markdown 渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2E7D32',
                        secondary: '#81C784',
                        neutral: '#F1F8E9',
                        dark: '#1B5E20',
                    }
                }
            }
        }
    </script>
    <style>
        .chat-bubble-ai {
            background-color: #FFFFFF;
            border: 1px solid #E8F5E9;
            border-radius: 18px 18px 18px 0;
            padding: 12px 16px;
            max-width: 80%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            /* 确保最小高度以容纳动画 */
            min-height: 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .chat-bubble-user {
            background-color: #81C784;
            color: #FFFFFF;
            border-radius: 18px 18px 0 18px;
            padding: 12px 16px;
            max-width: 80%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #F1F8E9;
        }
        ::-webkit-scrollbar-thumb {
            background: #C8E6C9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #81C784;
        }
        /* 底部导航样式 */
        .nav {
            display: flex;
            justify-content: space-around;
            background-color: white;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid #eee;
            z-index: 1000;
        }
        .nav-item {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .nav-item.active {
            color: #81c784;
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        /* Markdown 样式 */
        .markdown-content {
            color: #333;
            line-height: 1.6;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: #1B5E20;
        }
        .markdown-content h1 { font-size: 1.5em; border-bottom: 2px solid #81C784; padding-bottom: 0.3em; }
        .markdown-content h2 { font-size: 1.3em; border-bottom: 1px solid #C8E6C9; padding-bottom: 0.3em; }
        .markdown-content p { margin: 0.5em 0; }
        .markdown-content ul, .markdown-content ol { margin: 0.5em 0; padding-left: 2em; }
        .markdown-content li { margin: 0.25em 0; }
        .markdown-content code {
            background-color: #F1F8E9;
            color: #2E7D32;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        .markdown-content pre {
            background-color: #F1F8E9;
            border: 1px solid #C8E6C9;
            border-radius: 8px;
            padding: 12px;
            overflow-x: auto;
            margin: 0.5em 0;
        }
        .markdown-content pre code { background-color: transparent; color: inherit; padding: 0; }

        /* 消息加载动画 - 绿色跳跃小球 */
        .typing-indicator {
            display: flex;
            align-items: center;
            /* justify-content: center; */ /* 移除居中，因为后面有文字 */
            gap: 4px;
            height: 20px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #2E7D32; /* 绿色 */
            border-radius: 50%;
            animation: bounce-jump 1.2s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce-jump {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }
    </style>
</head>
<body class="bg-neutral min-h-screen">
    <!-- 顶部导航 -->
    <nav class="bg-primary text-white shadow-md fixed top-0 left-0 right-0 z-10">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="hover:text-secondary transition-colors">
                <i class="fas fa-arrow-left text-xl"></i>
            </a>
            <h1 class="text-xl font-bold flex items-center">
                <i class="fas fa-leaf mr-2"></i> 植物养护助手
            </h1>
            <div class="w-8"></div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-24 flex flex-col md:flex-row gap-6">
        <!-- 左侧：历史对话 + 知识库（电脑端显示，手机端隐藏） -->
        <div class="hidden md:block w-full md:w-64 lg:w-72 shrink-0">
            <!-- 历史对话 -->
            <div class="bg-white rounded-2xl shadow-md p-4 mb-6">
                <h2 class="text-lg font-semibold text-dark mb-4 flex items-center">
                    <i class="fas fa-clock text-primary mr-2"></i> 历史对话
                </h2>
                <div class="space-y-3" id="historyConversations">
                    <div class="text-center text-sm text-gray-500 py-4">
                        暂无历史对话
                    </div>
                </div>
            </div>

            <!-- 知识库搜索 -->
            <div class="bg-white rounded-2xl shadow-md p-4">
                <h2 class="text-lg font-semibold text-dark mb-4 flex items-center">
                    <i class="fas fa-book text-primary mr-2"></i> 养护知识库
                </h2>
                <div class="relative mb-4">
                    <input type="text" id="knowledgeSearch" placeholder="搜索养护知识..."
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 pl-10 outline-none focus:border-primary transition-colors">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="space-y-2 max-h-80 overflow-y-auto" id="knowledgeList">
                    <!-- 知识库内容将通过JS动态加载 -->
                </div>
            </div>
        </div>

        <!-- 右侧：对话区域（占满剩余宽度） -->
        <div class="w-full flex-1 flex flex-col">
            <!-- 对话内容 -->
            <div class="bg-white rounded-2xl shadow-md flex-1 overflow-hidden flex flex-col">
                <div class="p-4 flex-1 overflow-y-auto" id="chatContent">
                    <!-- 欢迎消息 -->
                    <div class="flex mb-6">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                        <div class="chat-bubble-ai">
                            <p class="text-gray-800">
                                你好呀！我是你的植物养护助手小植～ 有任何养护问题都可以问我哦！支持文字咨询：
                            </p>
                            <div class="mt-2 flex flex-wrap gap-2">
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('多肉叶子发黄怎么办？')">
                                    多肉叶子发黄怎么办？
                                </button>
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('绿萝多久浇一次水？')">
                                    绿萝多久浇一次水？
                                </button>
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('室内植物需要晒太阳吗？')">
                                    室内植物需要晒太阳吗？
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部：输入框区域 (移除了图片上传) -->
                <div class="border-t border-gray-100 p-4">
                    <div class="flex items-center mb-3">
                        <!-- 植物选择按钮 -->
                        <button type="button" id="selectPlantBtn" class="text-gray-500 hover:text-primary transition-colors flex items-center text-sm px-2 py-1 rounded hover:bg-gray-100">
                            <i class="fas fa-leaf mr-1"></i> 选择植物
                        </button>

                        <div class="ml-auto flex gap-2">
                            <button type="button" id="clearChatBtn" class="text-gray-500 hover:text-red-500 transition-colors text-sm">
                                新建对话
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="chatInput" placeholder="输入你的问题..."
                            class="flex-1 border border-gray-200 rounded-lg px-3 py-2 outline-none focus:border-primary transition-colors">
                        <button type="button" id="sendBtn" class="bg-primary text-white rounded-lg px-4 hover:bg-dark transition-colors">
                            发送
                        </button>
                    </div>
                </div>
            </div>

            <!-- 手机端：底部切换栏 -->
            <div class="md:hidden flex bg-white rounded-2xl shadow-md mt-4">
                <button type="button" class="flex-1 py-3 text-center text-primary border-b-2 border-primary font-medium" id="mobileChatTab">
                    对话
                </button>
                <button type="button" class="flex-1 py-3 text-center text-gray-500 font-medium" id="mobileKnowledgeTab">
                    知识库
                </button>
            </div>

            <!-- 手机端知识库（默认隐藏） -->
            <div class="md:hidden bg-white rounded-2xl shadow-md p-4 mt-4 hidden" id="mobileKnowledgePanel">
                <div class="relative mb-4">
                    <input type="text" id="mobileKnowledgeSearch" placeholder="搜索养护知识..."
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 pl-10 outline-none focus:border-primary transition-colors">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="space-y-2 max-h-60 overflow-y-auto" id="mobileKnowledgeList">
                    <!-- 知识库内容将通过JS动态加载 -->
                </div>
            </div>
        </div>
    </main>

    <!-- 知识库详情弹窗 -->
    <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden" id="knowledgeModal">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-dark" id="knowledgeTitle">知识库详情</h2>
                <button onclick="hideKnowledgeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-gray-700 space-y-3" id="knowledgeContent">
                <!-- 内容将通过JS动态填充 -->
            </div>
            <button class="w-full mt-6 bg-primary/10 text-primary py-2 rounded-lg hover:bg-primary/20 transition-colors" onclick="hideKnowledgeModal()">
                关闭
            </button>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="nav">
        <a href="index.html" class="nav-item"><i class="fas fa-home nav-icon"></i>首页</a>
        <a href="ai-assistant.html" class="nav-item active"><i class="fas fa-comments nav-icon"></i>AI助手</a>
        <a href="diary.html" class="nav-item"><i class="fas fa-seedling nav-icon"></i>日记</a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user nav-icon"></i>我的</a>
    </div>

    <script>
        // 配置后端API地址
        const API_BASE_URL = 'http://127.0.0.1:8000/api/v1/plant';

        // 全局变量
        let currentConversationId = '';
        let isSending = false;

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 加载历史对话
            loadHistoryConversations();
            // 加载知识库
            loadKnowledgeBase();

            // 绑定事件
            bindEvents();

            // 手机端切换栏事件
            setupMobileTabs();
        });

        // 绑定所有事件
        function bindEvents() {
            // 发送消息按钮
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    sendMessage();
                });
            }

            // 输入框回车发送
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // 清空对话按钮
            const clearChatBtn = document.getElementById('clearChatBtn');
            if (clearChatBtn) {
                clearChatBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (confirm('确定新建对话吗？')) {
                        resetChat();
                    }
                });
            }

            // 选择植物按钮
            const selectPlantBtn = document.getElementById('selectPlantBtn');
            if (selectPlantBtn) {
                selectPlantBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectPlant();
                });
            }

            // 知识库搜索
            const knowledgeSearch = document.getElementById('knowledgeSearch');
            if (knowledgeSearch) {
                knowledgeSearch.addEventListener('input', (e) => filterKnowledgeList(e.target.value, 'knowledgeList'));
            }

            const mobileKnowledgeSearch = document.getElementById('mobileKnowledgeSearch');
            if (mobileKnowledgeSearch) {
                mobileKnowledgeSearch.addEventListener('input', (e) => filterKnowledgeList(e.target.value, 'mobileKnowledgeList'));
            }
        }

        // 手机端Tab切换逻辑
        function setupMobileTabs() {
            const chatTab = document.getElementById('mobileChatTab');
            const knowledgeTab = document.getElementById('mobileKnowledgeTab');
            const knowledgePanel = document.getElementById('mobileKnowledgePanel');

            chatTab.addEventListener('click', () => {
                chatTab.className = 'flex-1 py-3 text-center text-primary border-b-2 border-primary font-medium';
                knowledgeTab.className = 'flex-1 py-3 text-center text-gray-500 font-medium';
                knowledgePanel.classList.add('hidden');
            });

            knowledgeTab.addEventListener('click', () => {
                knowledgeTab.className = 'flex-1 py-3 text-center text-primary border-b-2 border-primary font-medium';
                chatTab.className = 'flex-1 py-3 text-center text-gray-500 font-medium';
                knowledgePanel.classList.remove('hidden');
            });
        }

        // 重置聊天
        function resetChat() {
            const chatContent = document.getElementById('chatContent');
            if (chatContent) {
                chatContent.innerHTML = '';
                // 重新添加欢迎消息
                const welcomeMsg = `
                    <div class="flex mb-6">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                        <div class="chat-bubble-ai">
                            <p class="text-gray-800">
                                你好呀！我是你的植物养护助手小植～ 有任何养护问题都可以问我哦！支持文字咨询：
                            </p>
                            <div class="mt-2 flex flex-wrap gap-2">
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('多肉叶子发黄怎么办？')">
                                    多肉叶子发黄怎么办？
                                </button>
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('绿萝多久浇一次水？')">
                                    绿萝多久浇一次水？
                                </button>
                                <button class="bg-neutral text-primary text-xs px-2 py-1 rounded-full hover:bg-secondary/20 transition-colors" onclick="sendSampleQuestion('室内植物需要晒太阳吗？')">
                                    室内植物需要晒太阳吗？
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                chatContent.insertAdjacentHTML('beforeend', welcomeMsg);
                currentConversationId = '';
            }
        }

        // 选择植物
        function selectPlant() {
            const plants = getPlants();
            if (plants.length === 0) {
                alert('你还没有添加植物，快去添加植物档案吧～');
                return;
            }

            let plantOptions = '请选择要咨询的植物：\n';
            plants.forEach((plant, idx) => {
                plantOptions += `${idx + 1}. ${plant.nickname}（${plant.species}）\n`;
            });

            const selectedIdx = prompt(plantOptions);
            if (!selectedIdx || isNaN(selectedIdx) || selectedIdx < 1 || selectedIdx > plants.length) {
                return;
            }

            const selectedPlant = plants[selectedIdx - 1];
            document.getElementById('chatInput').value = `我想咨询${selectedPlant.nickname}（${selectedPlant.species}）的养护问题：`;
            document.getElementById('chatInput').focus();
        }

        // 发送示例问题
        function sendSampleQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendMessage();
        }

        // 发送消息
        async function sendMessage() {
            if (isSending) return;

            const input = document.getElementById('chatInput');
            const message = input ? input.value.trim() : '';

            if (!message) return;

            isSending = true;

            try {
                // 添加用户消息到对话
                addMessageToChat('user', message);

                // 清空输入框
                if (input) input.value = '';

                // 生成AI回复
                await generateAiReply(message);

            } catch (error) {
                console.error('发送消息失败:', error);
                addMessageToChat('ai', `抱歉，发送消息时出现错误：${error.message}`);
            } finally {
                isSending = false;
            }
        }

        // 添加消息到对话界面
        function addMessageToChat(type, content) {
            const chatContent = document.getElementById('chatContent');
            if (!chatContent) return;

            let msgHtml = '';

            if (type === 'user') {
                msgHtml = `
                    <div class="flex mb-6 justify-end">
                        <div class="chat-bubble-user">
                            <p>${escapeHtml(content)}</p>
                        </div>
                        <div class="w-10 h-10 bg-secondary/20 rounded-full flex items-center justify-center ml-3 flex-shrink-0">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </div>
                `;
            } else if (type === 'ai') {
                const markdownHtml = renderMarkdown(content);
                msgHtml = `
                    <div class="flex mb-6">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                        <div class="chat-bubble-ai">
                            <div class="text-gray-800 markdown-content">${markdownHtml}</div>
                        </div>
                    </div>
                `;
            } else if (type === 'loading') {
                // 加载动画气泡 + 文字提示
                msgHtml = `
                    <div class="flex mb-6">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                        <div class="chat-bubble-ai">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <span class="ml-2 text-gray-600 text-sm">小植正在思考中...</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            chatContent.insertAdjacentHTML('beforeend', msgHtml);
            chatContent.scrollTop = chatContent.scrollHeight;
        }

        // 生成AI回复
        async function generateAiReply(question) {
            // 显示加载状态（跳跃的小球 + 文字）
            addMessageToChat('loading');

            try {
                // 使用FormData发送数据，匹配后端Form接收方式
                const formData = new FormData();
                formData.append('message', question);

                if (currentConversationId) {
                    formData.append('conversation_id', currentConversationId);
                }

                // 发送请求
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errorMsg = `请求失败! 状态码: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.detail || errorMsg;
                    } catch (e) {}
                    throw new Error(errorMsg);
                }

                const data = await response.json();

                if (data.success) {
                    // 更新对话ID
                    if (data.conversation_id) {
                        currentConversationId = data.conversation_id;
                    }

                    // 移除加载消息
                    removeLastMessage();

                    // 添加真实回复
                    addMessageToChat('ai', data.message || '抱歉，没有收到有效的回复。');
                } else {
                    throw new Error(data.error || 'API返回失败');
                }

            } catch (error) {
                console.error('AI回复生成失败:', error);
                removeLastMessage();
                const errorMessage = `抱歉，AI助手暂时无法响应。错误：${escapeHtml(error.message)}`;
                addMessageToChat('ai', errorMessage);
            }
        }

        // 移除最后一条消息（用于移除加载动画）
        function removeLastMessage() {
            const chatContent = document.getElementById('chatContent');
            if (!chatContent) return;

            const messages = chatContent.querySelectorAll('.flex.mb-6');
            if (messages.length > 0) {
                messages[messages.length - 1].remove();
            }
        }

        // 加载知识库
        async function loadKnowledgeBase() {
            try {
                const response = await fetch(`${API_BASE_URL}/knowledge`);
                if (!response.ok) return;

                const data = await response.json();
                const knowledgeList = document.getElementById('knowledgeList');
                const mobileKnowledgeList = document.getElementById('mobileKnowledgeList');

                if (data.knowledge && data.knowledge.length > 0) {
                    const renderList = (container) => {
                        if (!container) return;
                        container.innerHTML = data.knowledge.map(item => `
                            <div class="p-3 bg-neutral rounded-lg text-sm text-gray-600 cursor-pointer hover:bg-secondary/20 transition-colors" onclick="showKnowledgeDetail('${item.id}')">
                                <div class="font-medium">${item.title}</div>
                                <div class="text-xs text-gray-500 mt-1">${item.category}</div>
                            </div>
                        `).join('');
                    };

                    renderList(knowledgeList);
                    renderList(mobileKnowledgeList);
                }
            } catch (error) {
                console.error('加载知识库失败:', error);
            }
        }

        // 加载历史对话
        async function loadHistoryConversations() {
            try {
                const response = await fetch(`${API_BASE_URL}/conversations`);
                if (!response.ok) return;

                const data = await response.json();
                const historyContainer = document.getElementById('historyConversations');

                if (!historyContainer) return;

                if (!data.conversations || data.conversations.length === 0) {
                    historyContainer.innerHTML = '<div class="text-center text-sm text-gray-500 py-4">暂无历史对话</div>';
                    return;
                }

                historyContainer.innerHTML = data.conversations.map(conv => {
                    const date = new Date(conv.created_at);
                    const dateStr = `${date.getMonth() + 1}月${date.getDate()}日`;

                    return `
                        <div class="p-3 bg-neutral rounded-lg cursor-pointer hover:bg-secondary/20 transition-colors" onclick="loadConversation('${conv.id}')">
                            <div class="flex justify-between items-start">
                                <h3 class="text-sm font-medium text-dark truncate">${conv.title || '无标题'}</h3>
                                <span class="text-xs text-gray-500">${dateStr}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 truncate">${conv.last_message || '暂无消息'}</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('加载历史对话失败:', error);
            }
        }

        // 加载特定对话
        async function loadConversation(convId) {
            try {
                const response = await fetch(`${API_BASE_URL}/conversations/${convId}`);
                if (!response.ok) return;

                const conv = await response.json();
                if (!conv) return;

                const chatContent = document.getElementById('chatContent');
                if (chatContent) chatContent.innerHTML = '';

                currentConversationId = convId;

                // 恢复对话历史
                if (conv.messages && conv.messages.length > 0) {
                    for (const msg of conv.messages) {
                        if (msg.role === 'user') {
                            addMessageToChat('user', msg.content);
                        } else if (msg.role === 'assistant') {
                            addMessageToChat('ai', msg.content);
                        }
                    }
                }
            } catch (error) {
                console.error('加载对话失败:', error);
            }
        }

        // 筛选知识库
        function filterKnowledgeList(keyword, listId) {
            const list = document.getElementById(listId);
            if (!list) return;

            const items = list.querySelectorAll('div[onclick]'); // 只选择有点击事件的项
            keyword = keyword.toLowerCase();

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(keyword) ? '' : 'none';
            });
        }

        // 显示知识库详情
        async function showKnowledgeDetail(knowledgeId) {
            try {
                const response = await fetch(`${API_BASE_URL}/knowledge/${knowledgeId}`);
                if (!response.ok) return;

                const knowledge = await response.json();
                const knowledgeModal = document.getElementById('knowledgeModal');

                document.getElementById('knowledgeTitle').textContent = knowledge.title;
                document.getElementById('knowledgeContent').innerHTML = renderMarkdown(knowledge.content);

                knowledgeModal.classList.remove('hidden');
            } catch (error) {
                console.error('加载知识详情失败:', error);
            }
        }

        function hideKnowledgeModal() {
            document.getElementById('knowledgeModal').classList.add('hidden');
        }

        // 获取本地存储的植物
        function getPlants() {
            try {
                return JSON.parse(localStorage.getItem('zhiwu_plants') || '[]');
            } catch (e) {
                return [];
            }
        }

        // Markdown渲染
        function renderMarkdown(text) {
            if (!text) return '';
            try {
                marked.setOptions({ breaks: true, gfm: true });
                let html = marked.parse(text);
                // 简单的代码高亮处理
                return html.replace(/<pre><code[^>]*>([\s\S]*?)<\/code><\/pre>/g, (match, code) => {
                    return `<pre><code class="hljs">${code}</code></pre>`;
                });
            } catch (e) {
                return text;
            }
        }

        // HTML转义
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }
    </script>
</body>
</html>