<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>植悟 - 我的</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4caf50',
                        secondary: '#f97316',
                        neutral: '#fdf5eb',
                        light: '#eef5d7',
                        accent: '#f5d7a9'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-neutral min-h-screen pb-20">
    <!-- 头部区域 -->
    <div class="header relative py-5 px-4 bg-gradient-to-br from-[#f0e6b9] to-[#f5d7a9] overflow-hidden">
        <h2 class="title text-2xl font-bold text-gray-800 mb-4 relative z-10">我的</h2>
        <div class="user-card flex items-center gap-4 bg-white/80 p-4 rounded-lg shadow-md relative z-10">
            <div class="relative">
                <div class="avatar w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center overflow-hidden" id="avatarContainer">
                    <i class="bi bi-person text-primary text-2xl"></i>
                </div>
                <button class="absolute bottom-0 right-0 bg-primary text-white rounded-full p-1 shadow-md hover:bg-primary/90 transition-colors" id="changeAvatarBtn">
                    <i class="bi bi-pencil text-xs"></i>
                </button>
                <input type="file" id="avatarUpload" accept="image/*" class="hidden">
            </div>
            <div class="user-info flex-1">
                <h3 class="text-lg font-semibold text-gray-800" id="userNickname">加载中...</h3>
                <p class="text-sm text-gray-600" id="userPhone">ID: ...</p>
                <!-- 新增：显示个性签名 -->
                <p class="text-xs text-gray-500 mt-1 italic" id="userSignatureDisplay"></p>
            </div>
            <div class="card-corner flex gap-2">
                <div class="corner-dot w-3 h-3 rounded-full bg-white/70"></div>
                <div class="corner-dot w-3 h-3 rounded-full bg-white/70"></div>
                <div class="corner-dot w-3 h-3 rounded-full bg-white/70"></div>
            </div>
        </div>
        <!-- 装饰元素 -->
        <div class="absolute -top-20 -right-20 w-60 h-60 bg-[#f8b78b]/20 rounded-full"></div>
    </div>

    <!-- 统计数据 -->
    <div class="stats flex justify-around py-4 bg-light">
        <div class="stat-item text-center">
            <div class="number text-2xl font-bold text-gray-800" id="plantCount">0</div>
            <div class="label text-sm text-gray-600 mt-1">我的植物</div>
        </div>
        <div class="stat-item text-center">
            <div class="number text-2xl font-bold text-gray-800" id="diaryCount">0</div>
            <div class="label text-sm text-gray-600 mt-1">养护记录</div>
        </div>
        <div class="stat-item text-center">
            <div class="number text-2xl font-bold text-gray-800" id="careCount">0</div>
            <div class="label text-sm text-gray-600 mt-1">养护天数</div>
        </div>
    </div>

    <!-- 功能菜单 -->
    <div class="menu mx-4 my-4 bg-white rounded-lg shadow-md overflow-hidden">
        <!-- 养护记录 -->
        <div class="menu-section p-4 border-b border-gray-100">
            <h4 class="text-base font-medium text-gray-800 mb-3 inline-block relative">
                养护记录
                <span class="absolute bottom-0 left-0 w-14 h-0.5 bg-primary"></span>
            </h4>
            <div class="record-grid flex gap-3 overflow-x-auto pb-2">
                <div class="record-item w-24 flex-shrink-0 rounded-lg overflow-hidden shadow-sm cursor-pointer" data-record-id="1">
                    <img src="https://picsum.photos/200/200?random=1" alt="植物养护记录" class="w-full h-24 object-cover">
                </div>
                <div class="record-item w-24 flex-shrink-0 rounded-lg overflow-hidden shadow-sm cursor-pointer" data-record-id="2">
                    <img src="https://picsum.photos/200/200?random=2" alt="植物养护记录" class="w-full h-24 object-cover">
                </div>
                <div class="record-item w-24 flex-shrink-0 rounded-lg overflow-hidden shadow-sm cursor-pointer" data-record-id="3">
                    <img src="https://picsum.photos/200/200?random=3" alt="植物养护记录" class="w-full h-24 object-cover">
                </div>
            </div>
        </div>

        <!-- 个人资料 -->
        <div class="menu-section p-4 border-b border-gray-100">
            <a href="#" class="menu-link flex justify-between items-center text-gray-800 hover:text-primary transition-colors" id="editProfileLink">
                <span>个人资料</span>
                <i class="bi bi-chevron-right text-gray-400"></i>
            </a>
        </div>

        <!-- 修改密码 -->
        <div class="menu-section p-4 border-b border-gray-100">
            <a href="#changePassword" class="menu-link flex justify-between items-center text-gray-800 hover:text-primary transition-colors">
                <span>更改密码</span>
                <i class="bi bi-chevron-right text-gray-400"></i>
            </a>
        </div>

        <!-- 意见反馈 -->
        <div class="menu-section p-4 border-b border-gray-100">
            <a href="#feedback" class="menu-link flex justify-between items-center text-gray-800 hover:text-primary transition-colors">
                <span>意见反馈</span>
                <i class="bi bi-chevron-right text-gray-400"></i>
            </a>
        </div>

        <!-- 关于我们 -->
        <div class="menu-section p-4 border-b border-gray-100">
            <a href="#about" class="menu-link flex justify-between items-center text-gray-800 hover:text-primary transition-colors">
                <span>关于我们</span>
                <i class="bi bi-chevron-right text-gray-400"></i>
            </a>
        </div>

        <!-- 用户协议 -->
        <div class="menu-section p-4 border-b border-gray-100">
            <a href="#agreement" class="menu-link flex justify-between items-center text-gray-800 hover:text-primary transition-colors">
                <span>用户协议与隐私政策</span>
                <i class="bi bi-chevron-right text-gray-400"></i>
            </a>
        </div>

        <!-- 删除账号 -->
        <div class="menu-section p-4">
            <a href="#deleteAccount" class="menu-link delete-link flex justify-between items-center text-red-500 pt-2 mt-2 border-t border-dashed border-gray-200">
                <span>删除账号</span>
                <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- 修改密码表单 -->
    <div class="bg-white rounded-lg shadow-md p-4 mx-4 mb-4 hidden" id="changePasswordForm">
        <h2 class="text-base font-semibold text-gray-800 mb-3">修改密码</h2>
        <form id="passwordForm" class="space-y-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">原密码</label>
                <input type="password" id="oldPassword" placeholder="请输入原密码" required
                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary transition-colors">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">新密码</label>
                <input type="password" id="newPassword" placeholder="请输入新密码（8位以上，含字母和数字）" required
                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary transition-colors">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">确认新密码</label>
                <input type="password" id="confirmNewPassword" placeholder="请再次输入新密码" required
                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary transition-colors">
            </div>
            <div class="flex gap-2 pt-2">
                <button type="button" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors" id="cancelChangePwdBtn">
                    取消
                </button>
                <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">
                    保存修改
                </button>
            </div>
        </form>
    </div>

    <!-- 退出登录按钮 -->
    <button class="w-full bg-white text-red-500 rounded-lg shadow-md py-3 font-medium hover:bg-red-50 transition-colors mx-4 mb-4" id="logoutBtn">
        退出登录
    </button>

    <!-- 编辑资料弹窗 -->
    <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 hidden" id="editProfileModal">
        <div class="w-full max-w-md bg-white rounded-lg shadow-xl p-5">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800">编辑个人资料</h2>
                <button onclick="hideEditProfileModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form id="profileForm" class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">昵称</label>
                    <input type="text" id="editNickname" placeholder="请输入昵称" required
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary transition-colors">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">个性签名</label>
                    <input type="text" id="editSignature" placeholder="请输入个性签名（不超过50字）" maxlength="50"
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary transition-colors">
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="button" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors" onclick="hideEditProfileModal()">
                        取消
                    </button>
                    <button type="submit" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">
                        保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 养护记录详情弹窗 -->
    <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 hidden" id="recordDetailModal">
        <div class="w-full max-w-md bg-white rounded-lg shadow-xl p-5 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800">养护记录详情</h2>
                <button onclick="hideRecordDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="record-detail-content">
                <img id="recordDetailImage" src="" alt="养护记录图片" class="w-full h-48 object-cover rounded-lg mb-3">
                <div class="space-y-2">
                    <p><span class="text-gray-500">植物名称：</span><span id="recordPlantName">加载中...</span></p>
                    <p><span class="text-gray-500">养护类型：</span><span id="recordCareType">加载中...</span></p>
                    <p><span class="text-gray-500">养护时间：</span><span id="recordTime">加载中...</span></p>
                    <p><span class="text-gray-500">养护备注：</span><span id="recordNote">加载中...</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <a href="index.html" class="nav-item"><i class="fas fa-home nav-icon"></i>首页</a>
        <a href="ai-assistant.html" class="nav-item"><i class="fas fa-comments nav-icon"></i>AI助手</a>
        <a href="diary.html" class="nav-item"><i class="fas fa-seedling nav-icon"></i>日记</a>
        <a href="profile.html" class="nav-item active"><i class="fas fa-user nav-icon"></i>我的</a>
    </div>

    <style>
        .nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        .nav-item {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .nav-item.active {
            color: #4caf50;
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
    </style>

<script>
    // ================= 配置区域 =================

    // 1. 修正 API 路径
    // 如果你的后端 router 是 app.include_router(..., prefix="/user")
    // 那么这里应该是 /api/v1/user。
    // 如果不确定，请保持 /api/v1，然后在下方请求时手动加 /user
    const API_BASE_URL = 'http://127.0.0.1:8000/api/v1/user_center';

    // 2. 修正 Token 名称 (必须与登录页保存的一致)
    const TOKEN_KEY = 'zhiwu_token';

    // ================= 工具函数 =================

    function getAuthHeaders() {
        const token = localStorage.getItem(TOKEN_KEY);
        if (!token) {
            console.warn('本地没有找到 Token，准备跳转登录页');
            window.location.href = 'login.html'; // 确保这里是你的登录页文件名
            return null;
        }
        return {
            'Authorization': `Bearer ${token}`
        };
    }

    async function apiRequest(endpoint, options = {}) {
        const headers = getAuthHeaders();
        if (!headers) return Promise.reject("No token");

        if (!(options.body instanceof FormData)) {
            headers['Content-Type'] = 'application/json';
        }

        const config = {
            ...options,
            headers: {
                ...headers,
                ...options.headers
            }
        };

        try {
            console.log(`正在请求: ${API_BASE_URL}${endpoint}`); // 调试日志
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);

            // 处理 401 (未授权)
            if (response.status === 401) {
                console.error('Token 失效或未授权');
                alert('登录已过期，请重新登录');
                localStorage.removeItem(TOKEN_KEY);
                window.location.href = 'login.html';
                return Promise.reject("Unauthorized");
            }

            // 处理其他 HTTP 错误
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`HTTP Error ${response.status}: ${errText}`);
            }

            const result = await response.json();

            // 处理业务逻辑错误 (code != 200)
            if (result.code !== 200) {
                throw new Error(result.msg || '请求失败');
            }

            return result;
        } catch (error) {
            console.error(`API 请求错误 [${endpoint}]:`, error);
            // 如果是网络错误（CORS 或 连接不上），不要直接跳登录页，而是弹窗提示，方便调试
            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                alert('连接服务器失败，请检查：\n1. 后端服务是否启动？\n2. 是否配置了 CORS？');
            }
            throw error;
        }
    }

    // 退出登录
    function performLogout() {
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem('zhiwu_user');
        window.location.href = 'login.html';
    }

    // ================= 业务逻辑 =================

    async function loadUserInfo() {
        try {
            // 请求 /profile (最终 URL: http://127.0.0.1:8000/api/v1/user/profile)
            const response = await apiRequest('/profile');
            const user = response.data;

            const nickname = user.nickname || '植物爱好者';
            const phone = user.phone || '';
            const maskedPhone = phone.length >= 11 ? phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2') : phone;
            const signature = user.signature || '';

            document.getElementById('userNickname').textContent = nickname;
            document.getElementById('userPhone').textContent = `ID: ${maskedPhone}`;
            document.getElementById('userSignatureDisplay').textContent = signature ? signature : '这里空空如也...';

            document.getElementById('editNickname').value = nickname;
            document.getElementById('editSignature').value = signature;

            if (user.avatar) {
                // 处理头像路径
                let avatarUrl = user.avatar;
                if (!avatarUrl.startsWith('http')) {
                    // 假设后端运行在 8000 端口
                    avatarUrl = `http://127.0.0.1:8000${avatarUrl.startsWith('/') ? '' : '/'}${avatarUrl}`;
                }
                document.getElementById('avatarContainer').innerHTML = `<img src="${avatarUrl}" alt="头像" class="w-full h-full object-cover">`;
            }
        } catch (error) {
            console.error('加载用户信息失败', error);
            document.getElementById('userNickname').textContent = '获取失败';
        }
    }

    async function loadStats() {
        // 暂时使用模拟数据，防止报错
        document.getElementById('plantCount').textContent = 4;
        document.getElementById('diaryCount').textContent = 12;
        document.getElementById('careCount').textContent = 35;
    }

    function bindEvents() {
        // 退出登录
        const logoutBtn = document.getElementById('logoutBtn');
        if(logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                if (confirm('确定要退出登录吗？')) {
                    performLogout();
                }
            });
        }

        // 上传头像
        const avatarBtn = document.getElementById('changeAvatarBtn');
        const avatarInput = document.getElementById('avatarUpload');

        if(avatarBtn && avatarInput) {
            avatarBtn.addEventListener('click', () => avatarInput.click());

            avatarInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('avatar', file);

                try {
                    const response = await apiRequest('/avatar', {
                        method: 'POST',
                        body: formData
                    });

                    let avatarUrl = response.data.avatarUrl;
                    if (!avatarUrl.startsWith('http')) {
                         avatarUrl = `http://127.0.0.1:8000${avatarUrl.startsWith('/') ? '' : '/'}${avatarUrl}`;
                    }

                    document.getElementById('avatarContainer').innerHTML = `<img src="${avatarUrl}" alt="头像" class="w-full h-full object-cover">`;
                    alert('头像上传成功！');
                } catch (error) {
                    alert('头像上传失败: ' + error.message);
                }
            });
        }

        // 提交资料修改
        const profileForm = document.getElementById('profileForm');
        if(profileForm) {
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nickname = document.getElementById('editNickname').value.trim();
                const signature = document.getElementById('editSignature').value.trim();

                try {
                    await apiRequest('/profile', {
                        method: 'PUT',
                        body: JSON.stringify({ nickname, signature })
                    });

                    document.getElementById('userNickname').textContent = nickname;
                    document.getElementById('userSignatureDisplay').textContent = signature;
                    hideEditProfileModal();
                    alert('资料更新成功');
                } catch (error) {
                    alert('更新失败: ' + error.message);
                }
            });
        }

        // 修改密码表单显示
        const pwdLink = document.querySelector('a[href="#changePassword"]');
        if(pwdLink) {
            pwdLink.addEventListener('click', (e) => {
                e.preventDefault();
                const form = document.getElementById('changePasswordForm');
                form.classList.remove('hidden');
                form.scrollIntoView({ behavior: 'smooth' });
            });
        }

        // 取消修改密码
        const cancelPwdBtn = document.getElementById('cancelChangePwdBtn');
        if(cancelPwdBtn) {
            cancelPwdBtn.addEventListener('click', () => {
                document.getElementById('changePasswordForm').classList.add('hidden');
                document.getElementById('passwordForm').reset();
            });
        }

        // 提交修改密码
        const pwdForm = document.getElementById('passwordForm');
        if(pwdForm) {
            pwdForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const oldPwd = document.getElementById('oldPassword').value;
                const newPwd = document.getElementById('newPassword').value;
                const confirmPwd = document.getElementById('confirmNewPassword').value;

                if (newPwd !== confirmPwd) {
                    alert('两次密码输入不一致');
                    return;
                }

                try {
                    await apiRequest('/password', {
                        method: 'PUT',
                        body: JSON.stringify({ oldPassword: oldPwd, newPassword: newPwd })
                    });
                    alert('密码修改成功，请重新登录');
                    performLogout();
                } catch (error) {
                    alert('密码修改失败: ' + error.message);
                }
            });
        }

        // 弹窗控制
        const editLink = document.getElementById('editProfileLink');
        if(editLink) {
            editLink.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('editProfileModal').classList.remove('hidden');
            });
        }
    }

    // 全局函数
    window.hideEditProfileModal = function() {
        document.getElementById('editProfileModal').classList.add('hidden');
    };

    // 养护记录详情相关 (模拟)
    window.showRecordDetailModal = function() {
        document.getElementById('recordDetailModal').classList.remove('hidden');
    }
    window.hideRecordDetailModal = function() {
        document.getElementById('recordDetailModal').classList.add('hidden');
    }
    document.querySelectorAll('.record-item').forEach(item => {
        item.addEventListener('click', showRecordDetailModal);
    });

    // 初始化
    window.addEventListener('load', () => {
        loadUserInfo();
        loadStats();
        bindEvents();
    });
</script>
</body>
</html>