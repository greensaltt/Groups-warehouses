<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤ç‰©æ—¥è®°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- æ ·å¼ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´ -->
    <style>
        /* ... è¯·ä¿ç•™ä½ åŸæ¥çš„ CSS æ ·å¼ ... */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "å¾®è½¯é›…é»‘", sans-serif; }
        body { background-color: #fdf6e3; padding-bottom: 60px; }
        .header { padding: 20px; }
        .title { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .weather { display: flex; align-items: center; background-color: #aed581; border-radius: 10px; padding: 10px; color: white; }
        .weather-text { font-size: 24px; margin-right: 10px; }
        .temperature { font-size: 16px; }
        .weather-icon { margin-left: auto; }
        .filter-bar { background-color: white; border-radius: 10px; margin: 0 20px; padding: 15px; }
        .filter-row { margin-bottom: 10px; }
        .filter-label { font-size: 14px; color: #666; margin-bottom: 5px; display: block; }
        .filter-select { width: 100%; border: 1px solid #eee; border-radius: 5px; padding: 8px; font-size: 14px; }
        .filter-buttons { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 5px 12px; border-radius: 20px; font-size: 14px; border: none; white-space: nowrap; cursor: pointer; }
        .filter-btn.active { background-color: #81c784; color: white; }
        .filter-btn:not(.active) { background-color: #f5f5f5; color: #666; }
        .plant-card { background-color: white; border-radius: 10px; margin: 20px; padding: 15px; }
        .plant-header { display: flex; align-items: center; margin-bottom: 15px; }
        .plant-img { width: 80px; height: 80px; border-radius: 5px; margin-right: 10px; object-fit: cover; }
        .plant-name { font-size: 20px; font-weight: bold; }
        .plant-info { font-size: 14px; color: #666; margin-top: 5px; }
        .diary-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f5f5f5; }
        .diary-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .diary-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .diary-date { font-size: 16px; }
        .diary-actions { display: flex; gap: 10px; }
        .diary-action { color: #999; cursor: pointer; }
        .diary-action.edit:hover { color: #81c784; }
        .diary-action.delete:hover { color: #e53935; }
        .diary-tags { display: flex; margin-bottom: 5px; }
        .tag { padding: 3px 8px; border-radius: 5px; font-size: 12px; margin-right: 8px; color: white; }
        .tag-water { background-color: #4dd0e1; }
        .tag-fertilize { background-color: #fbc02d; }
        .tag-prune { background-color: #81c784; }
        .tag-repot { background-color: #9575cd; }
        .tag-bloom { background-color: #e91e63; }
        .tag-pest { background-color: #ff9800; }
        .diary-content { font-size: 14px; margin-bottom: 10px; }
        .diary-imgs { display: flex; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .diary-img { width: 100px; height: 100px; border-radius: 5px; margin-right: 8px; flex-shrink: 0; object-fit: cover; }
        .empty-state { background-color: white; border-radius: 10px; margin: 20px; padding: 30px 15px; text-align: center; display: block; }
        .empty-icon { font-size: 48px; color: #ddd; margin-bottom: 15px; }
        .empty-text { font-size: 16px; color: #666; margin-bottom: 5px; }
        .empty-subtext { font-size: 14px; color: #999; margin-bottom: 20px; }
        .empty-btn { background-color: #81c784; color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; }
        .add-btn { position: fixed; bottom: 70px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background-color: #81c784; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav { display: flex; justify-content: space-around; background-color: white; padding: 10px 0; position: fixed; bottom: 0; left: 0; right: 0; border-top: 1px solid #eee; }
        .nav-item { text-decoration: none; color: #666; font-size: 14px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: #81c784; }
        .nav-icon { font-size: 20px; margin-bottom: 5px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 100; }
        .modal.show { display: flex; }
        .modal-content { background-color: white; width: 100%; border-top-left-radius: 16px; border-top-right-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .add-diary-header { padding: 16px; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .back-btn { width: 24px; height: 24px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%234CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="19 12 12 19 5 12 12 5 19 12"></polyline></svg>') no-repeat center; cursor: pointer; }
        .add-diary-title { flex: 1; text-align: center; font-size: 20px; font-weight: 600; color: #333; }
        .add-diary-main { padding: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; color: #666; margin-bottom: 8px; }
        .form-select, .form-input { width: 100%; border: 1px solid #eee; border-radius: 8px; padding: 10px; font-size: 16px; }
        .text-area { width: 100%; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 16px; margin-bottom: 16px; min-height: 150px; font-family: "å¾®è½¯é›…é»‘", sans-serif; font-size: 16px; }
        .text-placeholder { font-size: 16px; color: #999; margin-bottom: 8px; display: block; }
        .hint-text { font-size: 14px; color: #666; margin-top: 8px; display: block; }
        .photo-btn { width: 120px; height: 120px; background: #fff; border: 1px dashed #ddd; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 24px; cursor: pointer; }
        .photo-icon { width: 32px; height: 32px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>') no-repeat center; margin-bottom: 8px; }
        .photo-text { font-size: 14px; color: #666; }
        .photo-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; }
        .preview-img { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; position: relative; }
        .remove-photo { position: absolute; top: -5px; right: -5px; background-color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #e53935; border: 1px solid #e53935; cursor: pointer; }
        .complete-btn { width: 100%; height: 44px; background: linear-gradient(to right, #2E7D32, #4CAF50); color: #fff; border: none; border-radius: 22px; font-size: 16px; font-weight: 500; cursor: pointer; margin-top: 20px; }
        .edit-actions { display: flex; gap: 10px; margin-top: 20px; }
        .cancel-btn { flex: 1; height: 44px; background-color: #f5f5f5; color: #666; border: none; border-radius: 22px; font-size: 16px; font-weight: 500; cursor: pointer; }
        .save-btn { flex: 1; height: 44px; background: linear-gradient(to right, #2E7D32, #4CAF50); color: #fff; border: none; border-radius: 22px; font-size: 16px; font-weight: 500; cursor: pointer; }
        .hidden { display: none !important; }
        .error-message { color: #e53935; font-size: 14px; margin-top: 5px; display: none; }
        /* 12.11å¤©æ°”å›¾æ ‡é€šç”¨åŠ¨ç”»åŸºç±» */
.weather-icon-animate {
    display: inline-block; /* ç¡®ä¿åŠ¨ç”»ç”Ÿæ•ˆ */
}

/* å¤ªé˜³å‘¼å¸åŠ¨ç”» */
@keyframes sunPulse {
    0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
    50% { transform: scale(1.1) rotate(5deg); opacity: 0.9; }
}

/* äº‘æœµæ¼‚æµ®åŠ¨ç”» */
@keyframes cloudFloat {
    0%, 100% { transform: translateX(0) translateY(0); }
    50% { transform: translateX(5px) translateY(-2px); }
}

/* é›¨æ»´ä¸‹è½åŠ¨ç”» */
@keyframes rainDrop {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(5px); opacity: 0.8; }
}

/* é›ªèŠ±æ—‹è½¬åŠ¨ç”» */
@keyframes snowSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* é›¾éœ¾å‘¼å¸æ•ˆæœ */
@keyframes fogFade {
    0%, 100% { opacity: 1; filter: blur(0px); }
    50% { opacity: 0.8; filter: blur(1px); }
}

/* é—ªç”µé—ªçƒæ•ˆæœ */
@keyframes lightningFlash {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.05); }
    100% { opacity: 1; transform: scale(1); }
}
    </style>
</head>
<body>
    <!-- 12.11æ˜¾ç¤ºå¤©æ°” -->
    <div class="header">
        <div class="title">æ¤ç‰©æ—¥è®°</div>
        <div class="weather">
            <div class="weather-text" id="weatherText" style="font-size: 20px;">æ™´</div>
            <div class="temperature" id="weatherTemperature" style="font-size: 20px;">6â„ƒ-15â„ƒ</div>
            <div class="weather-icon" style="margin-right: 10px;">
                <i class="fas fa-sun" id="weatherIcon" style="font-size: 29px; color: #ffeb3b;"></i>
            </div>
        </div>
    </div>

    <!-- ç­›é€‰æ  -->
    <div class="filter-bar">
        <div class="filter-row">
            <div class="filter-label">ç­›é€‰æ¤ç‰©</div>
            <select id="diaryPlantFilter" class="filter-select">
                <option value="">å…¨éƒ¨æ¤ç‰©</option>
                <!-- åŠ¨æ€åŠ è½½ -->
            </select>
        </div>
        <div class="filter-row">
            <div class="filter-label">ç­›é€‰ç±»å‹</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-type="">å…¨éƒ¨æ—¥è®°</button>
                <button class="filter-btn" data-type="watering">æµ‡æ°´è®°å½•</button>
                <button class="filter-btn" data-type="fertilizing">æ–½è‚¥è®°å½•</button>
                <button class="filter-btn" data-type="pruning">å‰ªæè®°å½•</button>
                <button class="filter-btn" data-type="repotting">æ¢ç›†è®°å½•</button>
                <button class="filter-btn" data-type="blooming">å¼€èŠ±è®°å½•</button>
                <button class="filter-btn" data-type="pestControl">ç—…è™«å®³é˜²æ²»</button>
            </div>
        </div>
    </div>

    <!-- æ—¥è®°åˆ—è¡¨åŒº -->
    <div id="diaryList">
        <!-- åŠ¨æ€æ¸²æŸ“ -->
    </div>

    <!-- ç©ºçŠ¶æ€æç¤º -->
    <div id="emptyDiaryTip" class="empty-state" style="display: none;">
        <div class="empty-icon">
            <i class="fas fa-book-open"></i>
        </div>
        <div class="empty-text">è¿˜æ²¡æœ‰ç§æ¤æ—¥è®°å“¦</div>
        <div class="empty-subtext">è®°å½•æ¤ç‰©çš„æ¯ä¸€æ¬¡æˆé•¿ï¼Œç•™ä½å…»æŠ¤çš„ç¾å¥½ç¬é—´ï½</div>
        <button class="empty-btn" onclick="showAddDiaryModal()">è®°å½•ç¬¬ä¸€ç¯‡æ—¥è®°</button>
    </div>

    <!-- æ·»åŠ æ—¥è®°æŒ‰é’® -->
    <a href="#" class="add-btn" onclick="showAddDiaryModal()">+</a>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="nav">
        <a href="index.html" class="nav-item"><i class="fas fa-home nav-icon"></i>é¦–é¡µ</a>
        <a href="ai-assistant.html" class="nav-item"><i class="fas fa-comments nav-icon"></i>AIåŠ©æ‰‹</a>
        <a href="diary.html" class="nav-item active"><i class="fas fa-seedling nav-icon"></i>æ—¥è®°</a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user nav-icon"></i>æˆ‘çš„</a>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ å¼¹çª— (å¤ç”¨åŒä¸€ä¸ª Modal ç»“æ„) -->
    <div id="diaryModal" class="modal">
        <div class="modal-content">
            <div class="add-diary-header">
                <div class="back-btn" onclick="hideDiaryModal()"></div>
                <div class="add-diary-title" id="modalTitle">æ·»åŠ æ—¥è®°</div>
            </div>
            <div class="add-diary-main">
                <input type="hidden" id="modalDiaryId"> <!-- å­˜å‚¨ç¼–è¾‘æ—¶çš„ID -->

                <div class="form-group">
                    <label class="form-label">é€‰æ‹©æ¤ç‰© <span style="color: red;">*</span></label>
                    <select id="modalPlantId" class="form-select" required>
                        <option value="">è¯·é€‰æ‹©è¦è®°å½•çš„æ¤ç‰©</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">å…»æŠ¤ç±»å‹</label>
                    <select id="modalActivityType" class="form-select">
                        <option value="">æ—¥å¸¸è®°å½•</option>
                        <option value="watering">æµ‡æ°´</option>
                        <option value="fertilizing">æ–½è‚¥</option>
                        <option value="pruning">å‰ªæ</option>
                        <option value="repotting">æ¢ç›†</option>
                        <option value="blooming">å¼€èŠ±</option>
                        <option value="pestControl">ç—…è™«å®³é˜²æ²»</option>
                    </select>
                </div>

                <!-- è‡ªåŠ¨å¤©æ°”æç¤º (æ·»åŠ æ¨¡å¼æ˜¾ç¤º) -->
                <div id="autoWeatherTip" class="auto-weather-tip" style="display: none;">
                    <i class="fas fa-cloud-sun" style="margin-right: 8px;"></i>
                    <span>ç³»ç»Ÿå°†è‡ªåŠ¨è®°å½•å½“å‰åŸå¸‚çš„å®æ—¶å¤©æ°”å’Œæ¸©åº¦</span>
                </div>

                <!-- æ‰‹åŠ¨å¤©æ°”è¾“å…¥ (ç¼–è¾‘æ¨¡å¼æ˜¾ç¤º) -->
                <div id="manualWeatherInput" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">å¤©æ°”æƒ…å†µ</label>
                        <!-- æ”¹ä¸º text input ä»¥é€‚åº”åç«¯çš„ä¸­æ–‡è¿”å› -->
                        <input type="text" id="modalWeather" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ™´">
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¸©åº¦èŒƒå›´</label>
                        <input type="text" id="modalTemperature" placeholder="ä¾‹å¦‚ï¼š25Â°C" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å†…å®¹</label>
                    <textarea id="modalContent" class="text-area" placeholder="å¯ä»¥åœ¨è¿™é‡Œè®°å½•æ¤ç‰©å‘ç”Ÿçš„å˜åŒ–å“¦~"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
                    <div class="photo-preview" id="modalPhotoContainer">
                        <div class="photo-btn" id="modalAddPhotoBtn">
                            <div class="photo-icon"></div>
                            <div class="photo-text">æ·»åŠ ç…§ç‰‡</div>
                        </div>
                    </div>
                </div>

                <button class="complete-btn" onclick="submitDiary()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        //  1. é…ç½® API åœ°å€
        // ============================================
        // ç¡®ä¿è¿™ä¸¤ä¸ªåœ°å€ä¸ä½ çš„åç«¯å®Œå…¨ä¸€è‡´
        const API_ROOT = "http://127.0.0.1:8000/api/v1";       // ç”¨äº /get_plants
        const API_BASE = "http://127.0.0.1:8000/api/v1/diary"; // ç”¨äº /diaries
        const BASE_IMG_URL = 'http://127.0.0.1:8000/uploads/'; // å›¾ç‰‡åŸºç¡€è·¯å¾„

        // å…¨å±€å˜é‡
        let userPlants = [];
        let currentFilter = { plantId: '', activityType: '' };

        // éªŒè¯ Token
        const token = localStorage.getItem('zhiwu_token');
        if (!token) {
            console.warn("æ— Tokenï¼Œè·³è½¬ç™»å½•");
            window.location.href = 'login.html';
        }

        // 2. é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            console.log("é¡µé¢åŠ è½½å¯åŠ¨...");

            // ä¸²è¡Œæ‰§è¡Œï¼Œç¡®ä¿å…ˆæ‹¿åˆ°æ¤ç‰©åˆ—è¡¨ï¼ˆä¸ºäº†å›¾ç‰‡ï¼‰ï¼Œå†æ‹¿æ—¥è®°
            await loadPlants();
            await loadDiaries();

            getWeatherData();
            bindEvents();
        });

        // ---------------- API äº¤äº’å‡½æ•° ----------------

        // åŠ è½½æ¤ç‰©åˆ—è¡¨ (ç”¨äºè·å–å¤´åƒ)
        async function loadPlants() {
            try {
                console.log("æ­£åœ¨è¯·æ±‚æ¤ç‰©åˆ—è¡¨: " + `${API_ROOT}/get_plants`);
                const response = await fetch(`${API_ROOT}/get_plants`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log("æ¤ç‰©åˆ—è¡¨è¿”å›æ•°æ®:", result);

                if (result.code === 200) {
                    userPlants = result.data || [];
                    console.log("å·²ç¼“å­˜æ¤ç‰©æ•°æ®:", userPlants); // è°ƒè¯•ç‚¹ï¼šçœ‹è¿™é‡Œæœ‰æ²¡æœ‰ plantAvatar_url
                    renderPlantOptions();
                } else {
                    console.error("åç«¯è¿”å›é”™è¯¯:", result.msg);
                }
            } catch (error) {
                console.error("åŠ è½½æ¤ç‰©åˆ—è¡¨å¤±è´¥:", error);
            }
        }

        // åŠ è½½æ—¥è®°åˆ—è¡¨
        async function loadDiaries() {
            const listContainer = document.getElementById('diaryList');
            const emptyTip = document.getElementById('emptyDiaryTip');

            let query = `?skip=0&limit=100`;
            if (currentFilter.plantId) query += `&plant_id=${currentFilter.plantId}`;
            if (currentFilter.activityType) query += `&activity_type=${currentFilter.activityType}`;

            try {
                console.log("æ­£åœ¨è¯·æ±‚æ—¥è®°åˆ—è¡¨: " + `${API_BASE}/diaries${query}`);
                const response = await fetch(`${API_BASE}/diaries${query}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log("æ—¥è®°åˆ—è¡¨è¿”å›æ•°æ®:", result);

                if (result.code === 200) {
                    const diaries = result.data.diaries;
                    if (diaries.length === 0) {
                        listContainer.innerHTML = '';
                        emptyTip.style.display = 'block';
                    } else {
                        emptyTip.style.display = 'none';
                        renderDiaryList(diaries);
                    }
                } else {
                    alert("åŠ è½½æ—¥è®°å¤±è´¥: " + result.msg);
                }
            } catch (error) {
                console.error("åŠ è½½æ—¥è®°è¯·æ±‚å¤±è´¥:", error);
                alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯è¯¦æƒ…");
            }
        }

        // ---------------- æ¸²æŸ“å‡½æ•° (ä¿®å¤å›¾ç‰‡æ˜¾ç¤º) ----------------

        function renderDiaryList(diaries) {
            const listContainer = document.getElementById('diaryList');
            listContainer.innerHTML = '';

            const groups = {};

            diaries.forEach(d => {
                // 1. åˆå§‹åŒ–åˆ†ç»„
                if (!groups[d.plantId]) {
                    let plantName = d.plantNickname || 'æœªçŸ¥æ¤ç‰©';
                    let plantAvatar = null;

                    // 2. æ ¸å¿ƒè°ƒè¯•ï¼šæ‰“å°æ­£åœ¨æŸ¥æ‰¾çš„ID
                    // console.log(`æ­£åœ¨æŸ¥æ‰¾ ID ä¸º ${d.plantId} çš„æ¤ç‰©å¤´åƒ...`);

                    // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾æ¤ç‰©
                    const cachedPlant = userPlants.find(p => String(p.id) === String(d.plantId));

                    if (cachedPlant) {
                        plantName = cachedPlant.nickname;
                        // è¯»å–å¤´åƒå­—æ®µ
                        plantAvatar = cachedPlant.plantAvatar_url;
                        // console.log(`æ‰¾åˆ°æ¤ç‰© ${plantName}, å¤´åƒURL: ${plantAvatar}`);
                    }

                    // 3. å¤„ç† URL æ‹¼æ¥ (ä¿®å¤åæ–œæ é—®é¢˜)
                    if (plantAvatar) {
                        // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ (ä¸ä»¥ http å¼€å¤´)
                        if (!plantAvatar.startsWith('http')) {
                            // æ›¿æ¢ Windows çš„åæ–œæ  \ ä¸º /
                            const cleanPath = plantAvatar.replace(/\\/g, '/');
                            plantAvatar = BASE_IMG_URL + cleanPath;
                        }
                    }

                    groups[d.plantId] = {
                        plantName: plantName,
                        plantImg: plantAvatar,
                        items: []
                    };
                }
                groups[d.plantId].items.push(d);
            });

            // æ¸²æŸ“å¡ç‰‡
            Object.values(groups).forEach(group => {
                const card = document.createElement('div');
                card.className = 'plant-card';

                // 4. æ„å»ºå¤´åƒ HTML
                let headerImgHtml;
                if (group.plantImg) {
                    headerImgHtml = `
                        <img src="${group.plantImg}"
                             class="plant-img"
                             alt="${group.plantName}"
                             onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                        <div class="plant-emoji-placeholder" style="display:none">ğŸŒ±</div>
                    `;
                } else {
                    headerImgHtml = `<div class="plant-emoji-placeholder">ğŸŒ±</div>`;
                }

                let itemsHtml = '';
                group.items.forEach(item => {
                    const tagClass = getTagClass(item.activityType);
                    const tagText = getTagText(item.activityType);
                    const weatherText = getWeatherText(item.weather);

                    // å¤„ç†æ—¥è®°å†…å®¹å›¾ç‰‡
                    const imgsHtml = item.photos.map(src => {
                        let photoUrl = src;
                        if (src && !src.startsWith('http') && !src.startsWith('data:')) {
                             // åŒæ ·ä¿®å¤åæ–œæ 
                             photoUrl = BASE_IMG_URL + src.replace(/\\/g, '/');
                        }
                        return `<img src="${photoUrl}" class="diary-img">`;
                    }).join('');

                    itemsHtml += `
                        <div class="diary-item">
                            <div class="diary-header">
                                <div class="diary-date">${item.date}</div>
                                <div class="diary-actions">
                                    <span class="diary-action edit" onclick="showEditModal('${item.id}')"><i class="fas fa-pen"></i></span>
                                    <span class="diary-action delete" onclick="deleteDiary('${item.id}')"><i class="fas fa-trash"></i></span>
                                </div>
                            </div>
                            <div class="diary-tags">
                                ${item.activityType ? `<span class="tag ${tagClass}">${tagText}</span>` : ''}
                                ${item.weather ? `<span class="tag" style="background:#ddd;color:#555">${weatherText}</span>` : ''}
                            </div>
                            <div class="diary-content">${item.content}</div>
                            ${imgsHtml ? `<div class="diary-imgs">${imgsHtml}</div>` : ''}
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="plant-header">
                        ${headerImgHtml}
                        <div>
                            <div class="plant-name">${group.plantName}</div>
                        </div>
                    </div>
                    ${itemsHtml}
                `;
                listContainer.appendChild(card);
            });
        }

        // ---------------- æäº¤ä¸åˆ é™¤ ----------------

        async function submitDiary() {
            const diaryId = document.getElementById('modalDiaryId').value;
            const plantId = document.getElementById('modalPlantId').value;
            const content = document.getElementById('modalContent').value;

            if (!plantId) return alert("è¯·é€‰æ‹©æ¤ç‰©");
            if (!content) return alert("è¯·å¡«å†™å†…å®¹");

            const photos = [];
            document.querySelectorAll('#modalPhotoContainer .preview-img img').forEach(img => {
                photos.push(img.src);
            });

            const payload = {
                plantId: plantId,
                title: "æ—¥è®°",
                content: content,
                activityType: document.getElementById('modalActivityType').value,
                photos: photos,
                date: new Date().toISOString().split('T')[0]
            };

            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¸¦ä¸Šç”¨æˆ·è¾“å…¥çš„å¤©æ°”
            // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œåç«¯ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä¸éœ€è¦å¸¦
            if (diaryId) {
                payload.weather = document.getElementById('modalWeather').value;
                payload.temperature = document.getElementById('modalTemperature').value;
            }

            const url = diaryId ? `${API_BASE}/diaries/${diaryId}` : `${API_BASE}/diaries`;
            const method = diaryId ? 'PUT' : 'POST';

            // UI åé¦ˆ
            const btn = document.querySelector('.complete-btn');
            const oldText = btn.innerText;
            btn.innerText = "ä¿å­˜ä¸­...";
            btn.disabled = true;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                btn.innerText = oldText;
                btn.disabled = false;

                if (result.code === 200) {
                    alert("ä¿å­˜æˆåŠŸï¼");
                    hideDiaryModal();
                    loadDiaries();
                } else {
                    alert(result.msg || "ä¿å­˜å¤±è´¥");
                }
            } catch (error) {
                console.error("æäº¤å¤±è´¥", error);
                alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            }
        }

        async function deleteDiary(diaryId) {
            if (!confirm("ç¡®å®šåˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ")) return;
            try {
                const response = await fetch(`${API_BASE}/diaries/${diaryId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) loadDiaries();
            } catch (error) {
                console.error("åˆ é™¤å¤±è´¥", error);
            }
        }

        // ---------------- è¾…åŠ©å‡½æ•° ----------------

        function renderPlantOptions() {
            const filterSelect = document.getElementById('diaryPlantFilter');
            const modalSelect = document.getElementById('modalPlantId');
            filterSelect.innerHTML = '<option value="">å…¨éƒ¨æ¤ç‰©</option>';
            modalSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¦è®°å½•çš„æ¤ç‰©</option>';

            userPlants.forEach(plant => {
                const option = `<option value="${plant.id}">${plant.nickname}</option>`;
                filterSelect.insertAdjacentHTML('beforeend', option);
                modalSelect.insertAdjacentHTML('beforeend', option);
            });
        }

        function getTagClass(type) {
            const map = { 'watering': 'tag-water', 'fertilizing': 'tag-fertilize', 'pruning': 'tag-prune', 'repotting': 'tag-repot', 'blooming': 'tag-bloom', 'pestControl': 'tag-pest' };
            return map[type] || 'tag-repot';
        }
        function getTagText(type) {
            const map = { 'watering': 'æµ‡æ°´', 'fertilizing': 'æ–½è‚¥', 'pruning': 'å‰ªæ', 'repotting': 'æ¢ç›†', 'blooming': 'å¼€èŠ±', 'pestControl': 'ç—…è™«å®³é˜²æ²»' };
            return map[type] || 'æ—¥å¸¸è®°å½•';
        }
        function getWeatherText(weather) {
            const map = { 'sunny': 'æ™´', 'cloudy': 'å¤šäº‘', 'rainy': 'é›¨', 'windy': 'é£', 'snowy': 'é›ª' };
            return map[weather] || weather;
        }

        function showAddDiaryModal() {
            document.getElementById('modalTitle').innerText = "æ·»åŠ æ—¥è®°";
            document.getElementById('modalDiaryId').value = "";
            document.getElementById('modalContent').value = "";
            document.getElementById('modalPhotoContainer').innerHTML = `<div class="photo-btn" id="modalAddPhotoBtn" onclick="triggerFileUpload()"><div class="photo-icon"></div><div class="photo-text">æ·»åŠ ç…§ç‰‡</div></div>`;
            document.getElementById('diaryModal').classList.add('show');
        }

        async function showEditModal(diaryId) {
            try {
                const response = await fetch(`${API_BASE}/diaries/${diaryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.code === 200) {
                    const d = result.data;
                    document.getElementById('modalTitle').innerText = "ç¼–è¾‘æ—¥è®°";
                    document.getElementById('modalDiaryId').value = d.id;
                    document.getElementById('modalPlantId').value = d.plantId;
                    document.getElementById('modalActivityType').value = d.activityType;
                    document.getElementById('modalContent').value = d.content;
                    document.getElementById('modalTemperature').value = d.temperature;
                    const container = document.getElementById('modalPhotoContainer');
                    container.innerHTML = `<div class="photo-btn" id="modalAddPhotoBtn" onclick="triggerFileUpload()"><div class="photo-icon"></div></div>`;
                    d.photos.forEach(src => addPhotoPreview(src));
                    document.getElementById('diaryModal').classList.add('show');
                }
            } catch (e) { console.error(e); }
        }

        function hideDiaryModal() { document.getElementById('diaryModal').classList.remove('show'); }

        function triggerFileUpload() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = res => addPhotoPreview(res.target.result);
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function addPhotoPreview(src) {
            const div = document.createElement('div');
            div.className = 'preview-img';
            div.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover"><span class="remove-photo" onclick="this.parentElement.remove()">&times;</span>`;
            document.getElementById('modalPhotoContainer').insertBefore(div, document.getElementById('modalAddPhotoBtn'));
        }

        function bindEvents() {
            document.getElementById('diaryPlantFilter').addEventListener('change', e => {
                currentFilter.plantId = e.target.value; loadDiaries();
            });
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter.activityType = btn.dataset.type;
                    loadDiaries();
                });
            });
            document.getElementById('modalAddPhotoBtn').onclick = triggerFileUpload;
        }

        async function getWeatherData() {
            try {
                const response = await fetch(`${API_BASE}/weather/current`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (result.code === 200 && result.data) {
                    updateWeatherUI(result.data);
                } else {
                    document.getElementById('weatherText').textContent = "æœªçŸ¥";
                    document.getElementById('weatherIcon').className = "fas fa-question-circle";
                }
            } catch (error) {
                console.error("è·å–å¤©æ°”æ•°æ®å¤±è´¥", error);
            }
        }

        function updateWeatherUI(weather) {
            const textEl = document.getElementById('weatherText');
            const tempEl = document.getElementById('weatherTemperature');
            const iconEl = document.getElementById('weatherIcon');

            textEl.textContent = weather.text;
            tempEl.textContent = `${weather.temp}Â°C`;
            if(weather.temp.includes('C') || weather.temp.includes('c')) {
                 tempEl.textContent = weather.temp;
            }

            // å›¾æ ‡ä¸åŠ¨ç”»
            iconEl.className = '';
            iconEl.style = '';
            iconEl.style.fontSize = '32px';
            iconEl.style.transition = 'all 0.3s ease';

            // æ ¹æ®ä¸­æ–‡å¤©æ°”æè¿°åŒ¹é…å›¾æ ‡
            const w = weather.text;
            if (w.includes('æ™´')) {
                iconEl.className = 'fas fa-sun weather-icon-animate';
                iconElementStyle(iconEl, '#ffeb3b', 'sunPulse');
            } else if (w.includes('å¤šäº‘') || w.includes('é˜´')) {
                iconEl.className = 'fas fa-cloud weather-icon-animate';
                iconElementStyle(iconEl, '#f5f5f5', 'cloudFloat');
            } else if (w.includes('é›¨')) {
                iconEl.className = 'fas fa-cloud-rain weather-icon-animate';
                iconElementStyle(iconEl, '#64b5f6', 'rainDrop');
            } else if (w.includes('é›ª')) {
                iconEl.className = 'fas fa-snowflake weather-icon-animate';
                iconElementStyle(iconEl, '#e3f2fd', 'snowSpin');
            } else if (w.includes('é›·')) {
                iconEl.className = 'fas fa-bolt weather-icon-animate';
                iconElementStyle(iconEl, '#ffca28', 'lightningFlash');
            } else if (w.includes('é›¾') || w.includes('éœ¾')) {
                iconEl.className = 'fas fa-smog weather-icon-animate';
                iconElementStyle(iconEl, '#b0bec5', 'fogFade');
            } else {
                // é»˜è®¤
                iconEl.className = 'fas fa-cloud-sun weather-icon-animate';
                iconElementStyle(iconEl, '#fff', 'cloudFloat');
            }
        }

    </script>
</body>
</html>