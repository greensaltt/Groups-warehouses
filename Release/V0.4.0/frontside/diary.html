<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>植物日记</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- 样式保持你原来的设计不变 -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "微软雅黑", sans-serif; }
        body { background-color: #fdf6e3; padding-bottom: 60px; }
        .header { padding: 20px; }
        .title { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .weather { display: flex; align-items: center; background-color: #aed581; border-radius: 10px; padding: 10px; color: white; }
        .weather-text { font-size: 24px; margin-right: 10px; }
        .temperature { font-size: 16px; }
        .weather-icon { margin-left: auto; }
        .filter-bar { background-color: white; border-radius: 10px; margin: 0 20px; padding: 15px; }
        .filter-row { margin-bottom: 10px; }
        .filter-label { font-size: 14px; color: #666; margin-bottom: 5px; display: block; }
        .filter-select { width: 100%; border: 1px solid #eee; border-radius: 5px; padding: 8px; font-size: 14px; }
        .filter-buttons { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 5px 12px; border-radius: 20px; font-size: 14px; border: none; white-space: nowrap; cursor: pointer; }
        .filter-btn.active { background-color: #81c784; color: white; }
        .filter-btn:not(.active) { background-color: #f5f5f5; color: #666; }
        .plant-card { background-color: white; border-radius: 10px; margin: 20px; padding: 15px; }
        .plant-header { display: flex; align-items: center; margin-bottom: 15px; }
        .plant-img { width: 80px; height: 80px; border-radius: 5px; margin-right: 10px; object-fit: cover; }
        .plant-name { font-size: 20px; font-weight: bold; }
        .plant-info { font-size: 14px; color: #666; margin-top: 5px; }
        .diary-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f5f5f5; }
        .diary-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .diary-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .diary-date { font-size: 16px; }
        .diary-actions { display: flex; gap: 10px; }
        .diary-action { color: #999; cursor: pointer; }
        .diary-action.edit:hover { color: #81c784; }
        .diary-action.delete:hover { color: #e53935; }
        .diary-tags { display: flex; margin-bottom: 5px; }
        .tag { padding: 3px 8px; border-radius: 5px; font-size: 12px; margin-right: 8px; color: white; }
        .tag-water { background-color: #4dd0e1; }
        .tag-fertilize { background-color: #fbc02d; }
        .tag-prune { background-color: #81c784; }
        .tag-repot { background-color: #9575cd; }
        .tag-bloom { background-color: #e91e63; }
        .tag-pest { background-color: #ff9800; }
        .diary-content { font-size: 14px; margin-bottom: 10px; }
        .diary-imgs { display: flex; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .diary-img { width: 100px; height: 100px; border-radius: 5px; margin-right: 8px; flex-shrink: 0; object-fit: cover; }
        .empty-state { background-color: white; border-radius: 10px; margin: 20px; padding: 30px 15px; text-align: center; display: block; }
        .empty-icon { font-size: 48px; color: #ddd; margin-bottom: 15px; }
        .empty-text { font-size: 16px; color: #666; margin-bottom: 5px; }
        .empty-subtext { font-size: 14px; color: #999; margin-bottom: 20px; }
        .empty-btn { background-color: #81c784; color: white; border: none; border-radius: 20px; padding: 8px 16px; font-size: 14px; cursor: pointer; }
        .add-btn { position: fixed; bottom: 70px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background-color: #81c784; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav { display: flex; justify-content: space-around; background-color: white; padding: 10px 0; position: fixed; bottom: 0; left: 0; right: 0; border-top: 1px solid #eee; }
        .nav-item { text-decoration: none; color: #666; font-size: 14px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: #81c784; }
        .nav-icon { font-size: 20px; margin-bottom: 5px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: flex-end; z-index: 100; }
        .modal.show { display: flex; }
        .modal-content { background-color: white; width: 100%; border-top-left-radius: 16px; border-top-right-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .add-diary-header { padding: 16px; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .back-btn { width: 24px; height: 24px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%234CAF50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="19 12 12 19 5 12 12 5 19 12"></polyline></svg>') no-repeat center; cursor: pointer; }
        .add-diary-title { flex: 1; text-align: center; font-size: 20px; font-weight: 600; color: #333; }
        .add-diary-main { padding: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; color: #666; margin-bottom: 8px; }
        .form-select, .form-input { width: 100%; border: 1px solid #eee; border-radius: 8px; padding: 10px; font-size: 16px; }
        .text-area { width: 100%; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 16px; margin-bottom: 16px; min-height: 150px; font-family: "微软雅黑", sans-serif; font-size: 16px; }
        .text-placeholder { font-size: 16px; color: #999; margin-bottom: 8px; display: block; }
        .hint-text { font-size: 14px; color: #666; margin-top: 8px; display: block; }
        .photo-btn { width: 120px; height: 120px; background: #fff; border: 1px dashed #ddd; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 24px; cursor: pointer; }
        .photo-icon { width: 32px; height: 32px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>') no-repeat center; margin-bottom: 8px; }
        .photo-text { font-size: 14px; color: #666; }
        .photo-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px; }
        .preview-img { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; position: relative; }
        .remove-photo { position: absolute; top: -5px; right: -5px; background-color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #e53935; border: 1px solid #e53935; cursor: pointer; }
        .complete-btn { width: 100%; height: 44px; background: linear-gradient(to right, #2E7D32, #4CAF50); color: #fff; border: none; border-radius: 22px; font-size: 16px; font-weight: 500; cursor: pointer; margin-top: 20px; }

        /* 天气动画保持不变 */
        .weather-icon-animate { display: inline-block; }
        @keyframes sunPulse { 0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; } 50% { transform: scale(1.1) rotate(5deg); opacity: 0.9; } }
        @keyframes cloudFloat { 0%, 100% { transform: translateX(0) translateY(0); } 50% { transform: translateX(5px) translateY(-2px); } }
        @keyframes rainDrop { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(5px); opacity: 0.8; } }
        @keyframes snowSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fogFade { 0%, 100% { opacity: 1; filter: blur(0px); } 50% { opacity: 0.8; filter: blur(1px); } }
        @keyframes lightningFlash { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }

        /* 新增：自动天气提示的样式，保持原UI风格 */
        .auto-weather-tip {
            background-color: #f1f8e9; /* 浅绿色背景 */
            color: #558b2f;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            font-size: 14px;
            border: 1px dashed #81c784;
        }
    </style>
</head>
<body>
    <!-- 顶部天气栏 -->
    <div class="header">
        <div class="title">植物日记</div>
        <div class="weather">
            <div class="weather-text" id="weatherText" style="font-size: 20px;">获取中...</div>
            <div class="temperature" id="weatherTemperature" style="font-size: 20px;">--</div>
            <div class="weather-icon" style="margin-right: 10px;">
                <i class="fas fa-spinner fa-spin" id="weatherIcon" style="font-size: 29px; color: white;"></i>
            </div>
        </div>
    </div>

    <!-- 筛选栏 -->
    <div class="filter-bar">
        <div class="filter-row">
            <div class="filter-label">筛选植物</div>
            <select id="diaryPlantFilter" class="filter-select">
                <option value="">全部植物</option>
                <!-- 动态加载 -->
            </select>
        </div>
        <div class="filter-row">
            <div class="filter-label">筛选类型</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-type="">全部日记</button>
                <button class="filter-btn" data-type="watering">浇水</button>
                <button class="filter-btn" data-type="fertilizing">施肥</button>
                <button class="filter-btn" data-type="pruning">剪枝</button>
                <button class="filter-btn" data-type="repotting">换盆</button>
                <button class="filter-btn" data-type="blooming">开花</button>
                <button class="filter-btn" data-type="pestControl">驱虫</button>
            </div>
        </div>
    </div>

    <!-- 日记列表区 -->
    <div id="diaryList">
        <!-- 动态渲染 -->
    </div>

    <!-- 空状态提示 -->
    <div id="emptyDiaryTip" class="empty-state" style="display: none;">
        <div class="empty-icon">
            <i class="fas fa-book-open"></i>
        </div>
        <div class="empty-text">还没有种植日记哦</div>
        <div class="empty-subtext">记录植物的每一次成长，留住养护的美好瞬间～</div>
        <button class="empty-btn" onclick="showAddDiaryModal()">记录第一篇日记</button>
    </div>

    <!-- 添加日记按钮 -->
    <a href="#" class="add-btn" onclick="showAddDiaryModal()">+</a>

    <!-- 底部导航 -->
    <div class="nav">
        <a href="index.html" class="nav-item"><i class="fas fa-home nav-icon"></i>首页</a>
        <a href="ai-assistant.html" class="nav-item"><i class="fas fa-comments nav-icon"></i>AI助手</a>
        <a href="diary.html" class="nav-item active"><i class="fas fa-seedling nav-icon"></i>日记</a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user nav-icon"></i>我的</a>
    </div>

    <!-- 添加/编辑 弹窗 -->
    <div id="diaryModal" class="modal">
        <div class="modal-content">
            <div class="add-diary-header">
                <div class="back-btn" onclick="hideDiaryModal()"></div>
                <div class="add-diary-title" id="modalTitle">添加日记</div>
            </div>
            <div class="add-diary-main">
                <input type="hidden" id="modalDiaryId"> <!-- 存储编辑时的ID -->

                <div class="form-group">
                    <label class="form-label">选择植物 <span style="color: red;">*</span></label>
                    <select id="modalPlantId" class="form-select" required>
                        <option value="">请选择要记录的植物</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">养护类型</label>
                    <select id="modalActivityType" class="form-select">
                        <option value="">日常记录</option>
                        <option value="watering">浇水</option>
                        <option value="fertilizing">施肥</option>
                        <option value="pruning">剪枝</option>
                        <option value="repotting">换盆</option>
                        <option value="blooming">开花</option>
                        <option value="pestControl">病虫害防治</option>
                    </select>
                </div>

                <!-- 自动天气提示 (添加模式显示) -->
                <div id="autoWeatherTip" class="auto-weather-tip" style="display: none;">
                    <i class="fas fa-cloud-sun" style="margin-right: 8px;"></i>
                    <span>系统将自动记录当前城市的实时天气和温度</span>
                </div>

                <!-- 手动天气输入 (编辑模式显示) -->
                <div id="manualWeatherInput" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">天气情况</label>
                        <!-- 改为 text input 以适应后端的中文返回 -->
                        <input type="text" id="modalWeather" class="form-input" placeholder="例如：晴">
                    </div>

                    <div class="form-group">
                        <label class="form-label">温度范围</label>
                        <input type="text" id="modalTemperature" placeholder="例如：25°C" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">内容</label>
                    <textarea id="modalContent" class="text-area" placeholder="可以在这里记录植物发生的变化哦~"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">上传图片</label>
                    <div class="photo-preview" id="modalPhotoContainer">
                        <div class="photo-btn" id="modalAddPhotoBtn">
                            <div class="photo-icon"></div>
                            <div class="photo-text">添加照片</div>
                        </div>
                    </div>
                </div>

                <button class="complete-btn" onclick="submitDiary()">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 配置 API 地址
        const API_BASE = "http://127.0.0.1:8000/api/v1/diary";

        // 全局变量
        let userPlants = [];
        let currentFilter = { plantId: '', activityType: '' };

        // 1. 权限检查
        const token = localStorage.getItem('zhiwu_token');
        if (!token) {
            alert('请先登录');
            window.location.href = 'login.html';
        }

        // 2. 页面加载初始化
        window.addEventListener('load', async () => {
            getWeatherData();     // 获取天气
            await loadPlants();   // 加载植物列表
            loadDiaries();        // 加载日记列表
            bindEvents();         // 绑定事件
        });

        // ---------------- API 交互函数 ----------------

        // 加载植物列表
        async function loadPlants() {
            try {
                // 为了填充下拉框，请求一次日记列表获取植物信息（或者使用专门的 plants 接口）
                const response = await fetch(`${API_BASE}/diaries?limit=1`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.code === 200) {
                    userPlants = result.data.plants || [];
                    renderPlantOptions(); // 渲染下拉框
                }
            } catch (error) {
                console.error("加载植物失败", error);
            }
        }

        // 获取顶部实时天气
        async function getWeatherData() {
            try {
                const response = await fetch(`${API_BASE}/weather/current`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (result.code === 200 && result.data) {
                    updateWeatherUI(result.data);
                } else {
                    document.getElementById('weatherText').textContent = "未知";
                    document.getElementById('weatherIcon').className = "fas fa-question-circle";
                }
            } catch (error) {
                console.error("获取天气数据失败", error);
            }
        }

        // 加载日记列表
        async function loadDiaries() {
            const listContainer = document.getElementById('diaryList');
            const emptyTip = document.getElementById('emptyDiaryTip');

            let query = `?skip=0&limit=100`;
            if (currentFilter.plantId) query += `&plant_id=${currentFilter.plantId}`;
            if (currentFilter.activityType) query += `&activity_type=${currentFilter.activityType}`;

            try {
                const response = await fetch(`${API_BASE}/diaries${query}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.code === 200) {
                    const diaries = result.data.diaries;

                    if (diaries.length === 0) {
                        listContainer.innerHTML = '';
                        emptyTip.style.display = 'block';
                    } else {
                        emptyTip.style.display = 'none';
                        renderDiaryList(diaries);
                    }

                    // 如果日记列表接口顺便返回了最新天气，更新一下顶部UI
                    if(result.data.currentWeather) {
                        updateWeatherUI(result.data.currentWeather);
                    }
                }
            } catch (error) {
                console.error("加载日记失败", error);
            }
        }

        // 提交日记 (新建或更新)
        async function submitDiary() {
            const diaryId = document.getElementById('modalDiaryId').value;
            const plantId = document.getElementById('modalPlantId').value;
            const content = document.getElementById('modalContent').value;
            const activityType = document.getElementById('modalActivityType').value;

            if (!plantId) return alert("请选择植物");
            if (!content) return alert("请填写内容");

            // 收集图片
            const photos = [];
            document.querySelectorAll('#modalPhotoContainer .preview-img img').forEach(img => {
                photos.push(img.src);
            });

            const payload = {
                plantId: plantId,
                title: "日记",
                content: content,
                activityType: activityType,
                photos: photos,
                date: new Date().toISOString().split('T')[0]
            };

            // 如果是编辑模式，带上用户输入的天气
            // 如果是新建模式，后端会自动处理，不需要带
            if (diaryId) {
                payload.weather = document.getElementById('modalWeather').value;
                payload.temperature = document.getElementById('modalTemperature').value;
            }

            const url = diaryId ? `${API_BASE}/diaries/${diaryId}` : `${API_BASE}/diaries`;
            const method = diaryId ? 'PUT' : 'POST';

            // UI 反馈
            const btn = document.querySelector('.complete-btn');
            const oldText = btn.innerText;
            btn.innerText = "保存中...";
            btn.disabled = true;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                btn.innerText = oldText;
                btn.disabled = false;

                if (result.code === 200) {
                    if(!diaryId && result.data.extra_info) {
                        // 新建成功，提示自动获取到的天气
                        const info = result.data.extra_info;
                        alert(`发布成功！已自动记录天气：${info.weather} ${info.temperature}`);
                    } else {
                        alert("保存成功！");
                    }
                    hideDiaryModal();
                    loadDiaries(); // 刷新列表
                } else {
                    alert(result.msg || "保存失败");
                }
            } catch (error) {
                console.error("提交失败", error);
                btn.innerText = oldText;
                btn.disabled = false;
                alert("网络错误");
            }
        }

        // 删除日记
        async function deleteDiary(diaryId) {
            if (!confirm("确定删除这条日记吗？")) return;
            try {
                const response = await fetch(`${API_BASE}/diaries/${diaryId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) loadDiaries();
            } catch (error) {
                console.error("删除失败", error);
            }
        }

        // ---------------- 渲染函数 ----------------

        function renderPlantOptions() {
            const filterSelect = document.getElementById('diaryPlantFilter');
            const modalSelect = document.getElementById('modalPlantId');

            // 清空旧选项
            filterSelect.innerHTML = '<option value="">全部植物</option>';
            modalSelect.innerHTML = '<option value="">请选择要记录的植物</option>';

            userPlants.forEach(plant => {
                const option = `<option value="${plant.id}">${plant.nickname}</option>`;
                filterSelect.insertAdjacentHTML('beforeend', option);
                modalSelect.insertAdjacentHTML('beforeend', option);
            });
        }

        function renderDiaryList(diaries) {
            const listContainer = document.getElementById('diaryList');
            listContainer.innerHTML = '';

            // 按植物ID分组
            const groups = {};
            diaries.forEach(d => {
                if (!groups[d.plantId]) {
                    groups[d.plantId] = {
                        plantName: d.plantNickname,
                        plantImg: d.plantImageUrl || 'https://via.placeholder.com/80?text=Plant',
                        items: []
                    };
                }
                groups[d.plantId].items.push(d);
            });

            // 渲染卡片
            Object.values(groups).forEach(group => {
                const card = document.createElement('div');
                card.className = 'plant-card';

                let itemsHtml = '';
                group.items.forEach(item => {
                    const tagClass = getTagClass(item.activityType);
                    const tagText = getTagText(item.activityType);

                    // 图片数组处理
                    const imgsHtml = (item.photos || []).map(src =>
                        `<img src="${src}" class="diary-img" onclick="window.open('${src}')">`
                    ).join('');

                    itemsHtml += `
                        <div class="diary-item">
                            <div class="diary-header">
                                <div class="diary-date">${item.date}</div>
                                <div class="diary-actions">
                                    <span class="diary-action edit" onclick="showEditModal('${item.id}')"><i class="fas fa-pen"></i></span>
                                    <span class="diary-action delete" onclick="deleteDiary('${item.id}')"><i class="fas fa-trash"></i></span>
                                </div>
                            </div>
                            <div class="diary-tags">
                                ${item.activityType ? `<span class="tag ${tagClass}">${tagText}</span>` : ''}
                                <span class="tag" style="background:#e0e0e0;color:#555">
                                    <i class="fas fa-thermometer-half"></i> ${item.weather} ${item.temperature}
                                </span>
                            </div>
                            <div class="diary-content">${item.content}</div>
                            ${imgsHtml ? `<div class="diary-imgs">${imgsHtml}</div>` : ''}
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="plant-header">
                        <img src="${group.plantImg}" class="plant-img" onerror="this.src='https://via.placeholder.com/80?text=Plant'">
                        <div>
                            <div class="plant-name">${group.plantName}</div>
                            <div class="plant-info">${group.items.length} 篇日记</div>
                        </div>
                    </div>
                    ${itemsHtml}
                `;
                listContainer.appendChild(card);
            });
        }

        // 天气UI更新逻辑
        function updateWeatherUI(weather) {
            const textEl = document.getElementById('weatherText');
            const tempEl = document.getElementById('weatherTemperature');
            const iconEl = document.getElementById('weatherIcon');

            textEl.textContent = weather.text;
            tempEl.textContent = `${weather.temp}°C`;
            if(weather.temp.includes('C') || weather.temp.includes('c')) {
                 tempEl.textContent = weather.temp;
            }

            // 图标与动画
            iconEl.className = '';
            iconEl.style = '';
            iconEl.style.fontSize = '32px';
            iconEl.style.transition = 'all 0.3s ease';

            // 根据中文天气描述匹配图标
            const w = weather.text;
            if (w.includes('晴')) {
                iconEl.className = 'fas fa-sun weather-icon-animate';
                iconElementStyle(iconEl, '#ffeb3b', 'sunPulse');
            } else if (w.includes('多云') || w.includes('阴')) {
                iconEl.className = 'fas fa-cloud weather-icon-animate';
                iconElementStyle(iconEl, '#f5f5f5', 'cloudFloat');
            } else if (w.includes('雨')) {
                iconEl.className = 'fas fa-cloud-rain weather-icon-animate';
                iconElementStyle(iconEl, '#64b5f6', 'rainDrop');
            } else if (w.includes('雪')) {
                iconEl.className = 'fas fa-snowflake weather-icon-animate';
                iconElementStyle(iconEl, '#e3f2fd', 'snowSpin');
            } else if (w.includes('雷')) {
                iconEl.className = 'fas fa-bolt weather-icon-animate';
                iconElementStyle(iconEl, '#ffca28', 'lightningFlash');
            } else if (w.includes('雾') || w.includes('霾')) {
                iconEl.className = 'fas fa-smog weather-icon-animate';
                iconElementStyle(iconEl, '#b0bec5', 'fogFade');
            } else {
                // 默认
                iconEl.className = 'fas fa-cloud-sun weather-icon-animate';
                iconElementStyle(iconEl, '#fff', 'cloudFloat');
            }
        }

        function iconElementStyle(el, color, animName) {
            el.style.color = color;
            el.style.textShadow = `0 0 10px ${color}`;
            if (animName) {
                let dur = '3s';
                if(animName === 'rainDrop') dur = '1.5s';
                if(animName === 'lightningFlash') dur = '1s';
                el.style.animation = `${animName} ${dur} infinite ease-in-out`;
            }
        }

        // ---------------- 辅助函数 ----------------

        function getTagClass(type) {
            const map = { 'watering': 'tag-water', 'fertilizing': 'tag-fertilize', 'pruning': 'tag-prune', 'repotting': 'tag-repot', 'blooming': 'tag-bloom', 'pestControl': 'tag-pest' };
            return map[type] || 'tag-repot';
        }

        function getTagText(type) {
            const map = { 'watering': '浇水', 'fertilizing': '施肥', 'pruning': '剪枝', 'repotting': '换盆', 'blooming': '开花', 'pestControl': '病虫害防治' };
            return map[type] || '日常记录';
        }

        // ---------------- 模态框逻辑 ----------------

        function showAddDiaryModal() {
            document.getElementById('modalTitle').innerText = "添加日记";
            document.getElementById('modalDiaryId').value = "";
            document.getElementById('modalContent').value = "";
            document.getElementById('modalPlantId').value = "";
            document.getElementById('modalActivityType').value = "";

            // 重置图片
            document.getElementById('modalPhotoContainer').innerHTML = `
                <div class="photo-btn" id="modalAddPhotoBtn" onclick="triggerFileUpload()">
                    <div class="photo-icon"></div><div class="photo-text">添加照片</div>
                </div>`;

            // 【关键修改】添加模式：显示自动提示，隐藏手动输入
            document.getElementById('autoWeatherTip').style.display = 'flex';
            document.getElementById('manualWeatherInput').style.display = 'none';

            document.getElementById('diaryModal').classList.add('show');
        }

        async function showEditModal(diaryId) {
            try {
                const response = await fetch(`${API_BASE}/diaries/${diaryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                if (result.code === 200) {
                    const d = result.data;
                    document.getElementById('modalTitle').innerText = "编辑日记";
                    document.getElementById('modalDiaryId').value = d.id;
                    document.getElementById('modalPlantId').value = d.plantId;
                    document.getElementById('modalActivityType').value = d.activityType;
                    document.getElementById('modalContent').value = d.content;

                    // 【关键修改】编辑模式：显示输入框（并回显数据），隐藏自动提示
                    document.getElementById('autoWeatherTip').style.display = 'none';
                    document.getElementById('manualWeatherInput').style.display = 'block';

                    document.getElementById('modalWeather').value = d.weather || '';
                    document.getElementById('modalTemperature').value = d.temperature || '';

                    // 图片回显
                    const container = document.getElementById('modalPhotoContainer');
                    container.innerHTML = `<div class="photo-btn" id="modalAddPhotoBtn" onclick="triggerFileUpload()"><div class="photo-icon"></div></div>`;
                    (d.photos || []).forEach(src => addPhotoPreview(src));

                    document.getElementById('diaryModal').classList.add('show');
                }
            } catch (e) { console.error(e); }
        }

        function hideDiaryModal() {
            document.getElementById('diaryModal').classList.remove('show');
        }

        // 图片上传 (Base64)
        function triggerFileUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = res => addPhotoPreview(res.target.result);
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function addPhotoPreview(src) {
            const div = document.createElement('div');
            div.className = 'preview-img';
            div.innerHTML = `<img src="${src}" style="width:100%;height:100%;object-fit:cover"><span class="remove-photo" onclick="this.parentElement.remove()">&times;</span>`;
            const btn = document.getElementById('modalAddPhotoBtn');
            document.getElementById('modalPhotoContainer').insertBefore(div, btn);
        }

        // ---------------- 绑定事件 ----------------
        function bindEvents() {
            // 筛选
            document.getElementById('diaryPlantFilter').addEventListener('change', e => {
                currentFilter.plantId = e.target.value;
                loadDiaries();
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter.activityType = btn.dataset.type;
                    loadDiaries();
                });
            });

            const addPhotoBtn = document.getElementById('modalAddPhotoBtn');
            if(addPhotoBtn) addPhotoBtn.onclick = triggerFileUpload;
        }
    </script>
</body>
</html>