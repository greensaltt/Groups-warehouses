<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤æ‚Ÿ - æˆ‘çš„æ¤ç‰©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", sans-serif; }
        body { background-color: #fdf5e6; padding-bottom: 70px; }
        .header { display: flex; align-items: center; padding: 16px; background: linear-gradient(to right, #fff, #f8d7ad); position: fixed; top: 0; left: 0; right: 0; z-index: 10; }
        .back-arrow { width: 24px; height: 24px; margin-right: 16px; cursor: pointer; color: #666; }
        .search-box { display: flex; align-items: center; flex: 1; background-color: #fff; border-radius: 24px; padding: 8px 16px; position: relative; }
        .search-icon { width: 20px; height: 20px; margin-right: 8px; color: #666; }
        .search-input { border: none; outline: none; width: 100%; font-size: 14px; }
        .clear-search { width: 18px; height: 18px; color: #999; cursor: pointer; margin-left: 8px; display: none; }
        .section { padding: 16px; margin-top: 72px; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #333; }
        .my-plants, .popular-plants { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .plant-card { background-color: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .plant-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .add-plant { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px 0; cursor: pointer; }
        .add-icon { width: 40px; height: 40px; margin-bottom: 8px; color: #999; }
        .add-text { font-size: 14px; color: #999; }
        .plant-info { padding: 12px; }
        .plant-name { font-size: 16px; font-weight: bold; margin-bottom: 4px; color: #333; }
        .watering-tip { font-size: 12px; color: #666; }
        .plant-img, .popular-plant-img { width: 100%; height: 120px; object-fit: cover; }
        .edit-btn { position: absolute; top: 8px; right: 8px; background-color: rgba(255,255,255,0.8); border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; color: #666; cursor: pointer; transition: color 0.3s; z-index: 5; }
        .edit-btn:hover { color: #4CAF50; }
        .popular-plant-img { height: 100px; }
        .popular-plant-name { text-align: center; padding: 8px; font-size: 14px; font-weight: bold; color: #333; background-color: #fff; }
        .nav { display: flex; justify-content: space-around; padding: 10px 0; background-color: #fff; border-top: 1px solid #e5e7eb; position: fixed; bottom: 0; left: 0; right: 0; z-index: 10; }
        .nav-item { text-decoration: none; color: #666; font-size: 14px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: #81c784; }
        .nav-icon { font-size: 20px; margin-bottom: 5px; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; padding: 16px; display: none; }
        .modal-content { width: 100%; max-width: 400px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 20px; max-height: 85vh; overflow-y: auto; } /* å¢åŠ äº†é«˜åº¦é™åˆ¶å’Œæ»šåŠ¨ */
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: bold; color: #333; }
        .close-btn { color: #999; font-size: 20px; cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: medium; color: #333; margin-bottom: 6px; }
        .form-input, .form-select { width: 100%; border: 1px solid #eee; border-radius: 8px; padding: 10px; font-size: 14px; outline: none; transition: border-color 0.3s; }
        .form-input:focus, .form-select:focus { border-color: #4CAF50; }
        .photo-upload { display: flex; gap: 12px; margin-top: 8px; }
        .upload-item { width: 100px; height: 100px; border: 2px dashed #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999; cursor: pointer; transition: border-color 0.3s; overflow: hidden; position: relative; }
        .upload-item img { width: 100%; height: 100%; object-fit: cover; }
        .upload-item:hover { border-color: #4CAF50; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; border: none; }
        .btn-primary { background-color: #4CAF50; color: #fff; }
        .btn-primary:hover { background-color: #3d9940; }
        .btn-secondary { background-color: #f5f5f5; color: #333; }
        .btn-secondary:hover { background-color: #eee; }
        .btn-group { display: flex; gap: 12px; }
        .required { color: #ff4d4f; }
        .hidden { display: none; }
        /* è¯¦æƒ…æ ·å¼ */
        .plant-detail-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 16px; }
        .plant-detail-info { text-align: center; margin-bottom: 20px; }
        .plant-detail-name { font-size: 20px; font-weight: bold; margin-bottom: 8px; color: #333; }
        .plant-detail-species, .plant-detail-date { font-size: 14px; color: #666; margin-bottom: 4px; }
        .search-highlight { background-color: #fff9c4; padding: 2px 4px; border-radius: 4px; }
        .no-results { grid-column: 1 / -1; text-align: center; padding: 20px; color: #999; }
        /* æ–°å¢ï¼šä¸¤åˆ—å¸ƒå±€å·¥å…·ç±» */
        .grid-2-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .avatar-upload-container { margin-bottom: 20px; }
        .avatar-preview { width: 120px; height: 120px; border-radius: 8px; overflow: hidden; border: 2px solid #eee; margin: 0 auto 12px; }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        .upload-btn { display: inline-block; padding: 8px 16px; background-color: #4CAF50; color: white; border-radius: 6px; cursor: pointer; text-align: center; font-size: 14px; transition: background-color 0.3s; }
        .upload-btn:hover { background-color: #3d9940; }
        .file-input { display: none; }
        .upload-status { margin-top: 8px; font-size: 12px; text-align: center; color: #666; }
        .upload-status.success { color: #4CAF50; }
        .upload-status.error { color: #ff4d4f; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨åŒºåŸŸ (ä¿æŒä¸å˜) -->
    <div class="header">
        <svg class="back-arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="window.location.href='index.html'">
            <path d="M15.41 7.41L14 6L8 12L14 18L15.41 16.59L10.83 12L15.41 7.41Z" fill="#666"/>
        </svg>
        <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.5 14H14.71L14.17 13.46C15.24 12.16 15.5 10.59 15.5 9C15.5 5.13 12.37 2 8.5 2C4.63 2 1.5 5.13 1.5 9C1.5 12.87 4.63 16 8.5 16C10.09 16 11.63 15.66 12.82 15.04L13.36 15.59C12.06 16.66 10.47 17.24 8.5 17.24C6.56 17.24 4.84 16.86 3.45 16.14C1.97 15.34 0.86 14.02 0.86 12.22C0.86 10.42 1.97 9.1 3.45 8.3C4.84 7.58 6.56 7.2 8.5 7.2C10.47 7.2 12.06 7.78 13.36 8.85L12.82 9.4C11.63 8.78 10.09 8.44 8.5 8.44C6.91 8.44 5.37 8.8 4.18 9.42C3.0 10.04 2.17 11.04 1.83 12.22C1.49 13.4 2.02 14.84 3.17 15.84C4.32 16.84 5.76 17.37 7.04 17.37C8.32 17.37 9.76 16.84 10.91 15.84L15.5 11.26V14Z" fill="#666"/>
            </svg>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ¤ç‰©">
            <svg class="clear-search" id="clearSearch" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z" fill="currentColor"/>
            </svg>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="section">
        <!-- æˆ‘çš„æ¤ç‰©åŒºåŸŸ -->
        <div>
            <h2 class="section-title">æˆ‘çš„æ¤ç‰©</h2>
            <div class="my-plants" id="plantList">
                <div class="plant-card add-plant" onclick="showAddPlantModal()">
                    <svg class="add-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM13 7H11V11H7V13H11V17H13V13H17V11H13V7Z" fill="#999"/>
                    </svg>
                    <div class="add-text">æ·»åŠ æ¤ç‰©</div>
                </div>
            </div>
        </div>

        <!-- çƒ­é—¨æ¤ç‰©åŒºåŸŸ -->
        <div style="margin-top: 32px;">
            <h2 class="section-title">çƒ­é—¨æ¤ç‰©</h2>
            <div class="popular-plants" id="popularPlants">
                <!-- é™æ€å†…å®¹ -->
                <div class="plant-card" data-plant="succulent" onclick="showPopularPlantDetail('succulent')">
                    <img src="https://images.unsplash.com/photo-1459156212016-c812468e2115?w=200" alt="å¤šè‚‰" class="popular-plant-img">
                    <div class="popular-plant-name">å¤šè‚‰</div>
                </div>
                <div class="plant-card" data-plant="pothos" onclick="showPopularPlantDetail('pothos')">
                    <img src="https://images.unsplash.com/photo-1596720083162-841f3f982821?w=200" alt="ç»¿è" class="popular-plant-img">
                    <div class="popular-plant-name">ç»¿è</div>
                </div>
                <div class="plant-card" data-plant="rose" onclick="showPopularPlantDetail('rose')">
                    <img src="https://images.unsplash.com/photo-1559563458-52c69c8e31e4?w=200" alt="ç«ç‘°" class="popular-plant-img">
                    <div class="popular-plant-name">ç«ç‘°</div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ æ¤ç‰©å¼¹çª— (ä¿®æ”¹éƒ¨åˆ†ï¼šæ·»åŠ å¤´åƒä¸Šä¼ åŠŸèƒ½) -->
    <div class="modal" id="addPlantModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ æ–°æ¤ç‰©</h2>
                <svg class="close-btn" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="hideAddPlantModal()">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z" fill="#999"/>
                </svg>
            </div>
            <form id="addPlantForm" class="space-y-4">
                <!-- 1. æ¤ç‰©å¤´åƒä¸Šä¼  -->
                <div class="avatar-upload-container">
                    <label class="form-label">æ¤ç‰©å¤´åƒ</label>
                    <div class="avatar-preview">
                        <img id="avatarPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f9ff'/%3E%3Ctext x='50' y='60' font-size='36' text-anchor='middle' fill='%234CAF50'%3EğŸŒ±%3C/text%3E%3C/svg%3E" alt="æ¤ç‰©å¤´åƒé¢„è§ˆ">
                    </div>
                    <div class="text-center">
                        <input type="file" id="avatarFile" accept="image/*" class="file-input" onchange="uploadAvatar()">
                        <label for="avatarFile" class="upload-btn">
                            <i class="fas fa-camera mr-1"></i> ä¸Šä¼ å›¾ç‰‡
                        </label>
                        <div id="uploadStatus" class="upload-status"></div>
                    </div>
                </div>

                <!-- 2. åŸºç¡€ä¿¡æ¯ -->
                <div class="form-group">
                    <label class="form-label">æ¤ç‰©æ˜µç§° <span class="required">*</span></label>
                    <input type="text" id="plantNickname" required class="form-input" placeholder="ä¾‹å¦‚ï¼šå®¢å…çš„å¤§å‘è´¢æ ‘">
                </div>
                <div class="form-group">
                    <label class="form-label">æ¤ç‰©å“ç§ <span class="required">*</span></label>
                    <select id="plantSpecies" required class="form-select">
                        <option value="è§‚å¶æ¤ç‰©">è§‚å¶æ¤ç‰©ï¼ˆå¦‚ç»¿èã€å‘è´¢æ ‘ã€é¾ŸèƒŒç«¹ç­‰ï¼‰</option>
                        <option value="å¤šè‚‰æ¤ç‰©">å¤šè‚‰æ¤ç‰©ï¼ˆå¦‚ä»™äººæŒã€èŠ¦èŸç­‰ï¼‰</option>
                        <option value="å¼€èŠ±æ¤ç‰©">å¼€èŠ±æ¤ç‰©ï¼ˆå¦‚ç™½æŒã€ç´«ç½—å…°ã€èŒ‰è‰ç­‰ï¼‰</option>
                        <option value="æ£•æ¦ˆ/ä¹”æœ¨ç±»">æ£•æ¦ˆ/ä¹”æœ¨ç±»ï¼ˆå¦‚æ•£å°¾è‘µã€ç´å¶æ¦•ç­‰ï¼‰</option>
                        <option value="è—¤è”“/å‚åŠæ¤ç‰©">è—¤è”“/å‚åŠæ¤ç‰©ï¼ˆå¦‚åŠå…°ã€ç»¿èã€å¸¸æ˜¥è—¤ç­‰ï¼‰</option>
                        <option value="å…¶ä»–">å…¶ä»–å“ç§</option>
                    </select>
                </div>

                <!-- 3. æµ‡æ°´è®¾ç½® (ä½¿ç”¨ grid-2-cols æ’åˆ—) -->
                <div class="grid-2-cols">
                    <div class="form-group">
                        <label class="form-label">ä¸Šæ¬¡æµ‡æ°´ <span class="required">*</span></label>
                        <input type="date" id="lastWatered" required class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æµ‡æ°´å‘¨æœŸ(å¤©) <span class="required">*</span></label>
                        <input type="number" id="waterCycle" value="7" min="1" class="form-input">
                    </div>
                </div>

                <!-- 4. æ–½è‚¥è®¾ç½® (å¯é€‰) -->
                <div class="grid-2-cols">
                    <div class="form-group">
                        <label class="form-label">ä¸Šæ¬¡æ–½è‚¥ <span class="text-gray-400 text-xs">(å¯é€‰)</span></label>
                        <input type="date" id="lastFertilized" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ–½è‚¥å‘¨æœŸ(å¤©)</label>
                        <input type="number" id="fertilizeCycle" value="30" min="1" class="form-input">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">ä¿å­˜æ¤ç‰©æ¡£æ¡ˆ</button>
            </form>
        </div>
    </div>

    <!-- æ¤ç‰©è¯¦æƒ…å¼¹çª— (ä¿æŒä¸å˜) -->
    <div class="modal plant-detail-modal" id="plantDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ¤ç‰©è¯¦æƒ…</h2>
                <svg class="close-btn" onclick="hidePlantDetailModal()" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                     <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z" fill="#999"/>
                </svg>
            </div>
            <div id="plantDetailContent"></div>
        </div>
    </div>

    <!-- çƒ­é—¨æ¤ç‰©è¯¦æƒ…å¼¹çª— (ä¿æŒä¸å˜) -->
    <div class="modal popular-plant-detail-modal" id="popularPlantDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ¤ç‰©ç™¾ç§‘</h2>
                <svg class="close-btn" onclick="hidePopularPlantDetailModal()" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z" fill="#999"/>
                </svg>
            </div>
            <div id="popularPlantDetailContent"></div>
            <div class="btn-group" style="margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="addThisPlant()">æ·»åŠ æ­¤æ¤ç‰©</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="nav">
        <a href="index.html" class="nav-item active"><i class="fas fa-home nav-icon"></i>é¦–é¡µ</a>
        <a href="ai-assistant.html" class="nav-item"><i class="fas fa-comments nav-icon"></i>AIåŠ©æ‰‹</a>
        <a href="diary.html" class="nav-item"><i class="fas fa-seedling nav-icon"></i>æ—¥è®°</a>
        <a href="profile.html" class="nav-item"><i class="fas fa-user nav-icon"></i>æˆ‘çš„</a>
    </div>

    <script>
        // ============================================
        //  åç«¯ API é…ç½®
        // ============================================
        const API_BASE_URL = 'http://127.0.0.1:8000/api/v1';
        // 1. å®šä¹‰å›¾ç‰‡åŸºç¡€è·¯å¾„ (ä¸ index.html ä¿æŒä¸€è‡´)
        const BASE_IMG_URL = 'http://127.0.0.1:8000/uploads/';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function getAuthHeaders(contentType = 'application/json') {
            const token = localStorage.getItem('zhiwu_token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'login.html';
                return null;
            }
            const headers = {
                'Authorization': `Bearer ${token}`
            };
            if (contentType) {
                headers['Content-Type'] = contentType;
            }
            return headers;
        }

        // å…¨å±€å˜é‡
        let userPlantsCache = [];
        let currentPopularPlant = null;
        let uploadedAvatarUrl = null; // å­˜å‚¨ä¸Šä¼ æˆåŠŸçš„å¤´åƒURL

        // çƒ­é—¨æ¤ç‰©æ•°æ®
        const popularPlantsData = {
            'succulent': { name: 'å¤šè‚‰', description: 'é€‚åˆæ–°æ‰‹ï¼Œå°‘æµ‡æ°´ï¼Œå¤šæ™’å¤ªé˜³ã€‚', careTips: 'å¹²é€æµ‡é€ï¼Œå®å¹²å‹¿æ¹¿ã€‚' },
            'pothos': { name: 'ç»¿è', description: 'é‡æ°´å³æ´»ï¼Œå‡€åŒ–ç©ºæ°”å°èƒ½æ‰‹ã€‚', careTips: 'å–œé˜´ï¼Œä¿æŒåœŸå£¤æ¹¿æ¶¦ã€‚' },
            'rose': { name: 'ç«ç‘°', description: 'éœ€è¦å……è¶³å…‰ç…§ï¼Œè±¡å¾çˆ±æƒ…ã€‚', careTips: 'å‹¤æ–½è‚¥ï¼Œå¤šä¿®å‰ªã€‚' }
        };

        // ============================================
        //  æ ¸å¿ƒé€»è¾‘ï¼šä¸åç«¯äº¤äº’
        // ============================================

        // 1. è·å–æ¤ç‰©åˆ—è¡¨
        async function fetchPlants() {
            const headers = getAuthHeaders();
            if (!headers) return;

            try {
                // ç¡®è®¤è·¯ç”±åœ°å€ï¼š/get_plants æˆ– /reminders/get_plants
                const res = await fetch(`${API_BASE_URL}/get_plants`, { headers });
                const data = await res.json();

                if (data.code === 200) {
                    userPlantsCache = data.data;
                    renderPlantList(userPlantsCache);
                }
            } catch (err) {
                console.error("åŠ è½½æ¤ç‰©å¤±è´¥", err);
            }
        }

        // 2. ä¸Šä¼ æ¤ç‰©å¤´åƒ
        async function uploadAvatar() {
            const fileInput = document.getElementById('avatarFile');
            const file = fileInput.files[0];

            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showUploadStatus('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º5MB)
            if (file.size > 5 * 1024 * 1024) {
                showUploadStatus('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ é¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);

            // ä¸Šä¼ åˆ°æœåŠ¡å™¨
            const formData = new FormData();
            formData.append('file', file);

            const headers = getAuthHeaders(null); // FormDataä¸éœ€è¦Content-Typeå¤´éƒ¨

            showUploadStatus('æ­£åœ¨ä¸Šä¼ ... <div class="loading-spinner inline-block ml-2"></div>', '');

            try {
                const res = await fetch(`${API_BASE_URL}/upload_avatar`, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                const data = await res.json();

                if (data.code === 200) {
                    uploadedAvatarUrl = data.data.url;
                    showUploadStatus('ä¸Šä¼ æˆåŠŸï¼', 'success');
                } else {
                    showUploadStatus('ä¸Šä¼ å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'), 'error');
                    document.getElementById('avatarPreview').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f9ff'/%3E%3Ctext x='50' y='60' font-size='36' text-anchor='middle' fill='%234CAF50'%3EğŸŒ±%3C/text%3E%3C/svg%3E";
                    uploadedAvatarUrl = null;
                }
            } catch (err) {
                console.error('ä¸Šä¼ å¤±è´¥:', err);
                showUploadStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡', 'error');
                uploadedAvatarUrl = null;
            }
        }

        // 3. æ·»åŠ æ¤ç‰© (Create)
        async function createPlant(plantData) {
            const headers = getAuthHeaders();
            if (!headers) return;

            try {
                const res = await fetch(`${API_BASE_URL}/plants`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(plantData)
                });
                const data = await res.json();

                if (data.code === 200) {
                    alert('æ¤ç‰©æ·»åŠ æˆåŠŸï¼');
                    resetAddForm();
                    hideAddPlantModal();
                    fetchPlants(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (data.msg || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (err) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
            }
        }

        // ============================================
        //  è¾…åŠ©å‡½æ•°
        // ============================================

        function showUploadStatus(message, type) {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.innerHTML = message;
            statusEl.className = 'upload-status';
            if (type) {
                statusEl.classList.add(type);
            }
        }

        function resetAddForm() {
            // é‡ç½®è¡¨å•
            document.getElementById('addPlantForm').reset();
            document.getElementById('avatarPreview').src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f9ff'/%3E%3Ctext x='50' y='60' font-size='36' text-anchor='middle' fill='%234CAF50'%3EğŸŒ±%3C/text%3E%3C/svg%3E";
            document.getElementById('uploadStatus').innerHTML = '';
            uploadedAvatarUrl = null;

            // é‡æ–°è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('lastWatered').value = today;
        }

        // ============================================
        //  æ¸²æŸ“é€»è¾‘
        // ============================================

        function renderPlantList(plants) {
            const plantList = document.getElementById('plantList');
            // ä¿ç•™ç¬¬ä¸€ä¸ª"æ·»åŠ æŒ‰é’®"
            const addCardHtml = `
                <div class="plant-card add-plant" onclick="showAddPlantModal()">
                    <svg class="add-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM13 7H11V11H7V13H11V17H13V13H17V11H13V7Z" fill="#999"/>
                    </svg>
                    <div class="add-text">æ·»åŠ æ¤ç‰©</div>
                </div>`;

            // ç”Ÿæˆæ¤ç‰©å¡ç‰‡ HTML
            const cardsHtml = plants.map(plant => {
                const cycle = plant.water_cycle || 7;
                const last = plant.last_watered ? new Date(plant.last_watered) : new Date();
                const next = new Date(last);
                next.setDate(last.getDate() + cycle);

                const diffTime = next - new Date();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const tip = diffDays > 0 ? `${diffDays}å¤©åæµ‡æ°´` : `éœ€ç«‹å³æµ‡æ°´`;

                // 2. ä¿®æ”¹ï¼šæ¸²æŸ“å›¾ç‰‡
                let imgContent;
                if (plant.plantAvatar_url) {
                    // æ‹¼æ¥å®Œæ•´ URL
                    let finalUrl = plant.plantAvatar_url;
                    if (!finalUrl.startsWith('http')) {
                         finalUrl = BASE_IMG_URL + finalUrl;
                    }

                    imgContent = `
                        <img src="${finalUrl}"
                             alt="${plant.nickname}"
                             class="plant-img"
                             onerror="this.parentElement.innerHTML='<div class=\'plant-placeholder\'>ğŸŒ±</div>'">
                    `;
                } else {
                    // é»˜è®¤å ä½ç¬¦
                    imgContent = `<div class="plant-placeholder">ğŸŒ±</div>`;
                }

                return `
                <div class="plant-card" onclick="showPlantDetail(${plant.id})">
                    ${imgContent}
                    <div class="plant-info">
                        <div class="plant-name">${plant.nickname}</div>
                        <div class="watering-tip text-green-600">${tip}</div>
                    </div>
                </div>
                `;
            }).join('');

            plantList.innerHTML = addCardHtml + cardsHtml;
        }

        // ============================================
        //  UI äº¤äº’äº‹ä»¶
        // ============================================

        // é¡µé¢åŠ è½½
        window.addEventListener('load', () => {
            fetchPlants();

            // åˆå§‹åŒ–æ—¥æœŸï¼šé»˜è®¤é€‰ä¸­ä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('lastWatered').value = today;
            // æ–½è‚¥æ—¥æœŸä¸é»˜è®¤ï¼Œå› ä¸ºä¸ä¸€å®šæ–½è‚¥äº†
        });

        // æäº¤æ·»åŠ è¡¨å• (æ•°æ®ç»„è£…é€»è¾‘æ›´æ–°)
        document.getElementById('addPlantForm').addEventListener('submit', (e) => {
            e.preventDefault();

            // è·å–è¡¨å•æ•°æ®
            const nickname = document.getElementById('plantNickname').value;
            const species = document.getElementById('plantSpecies').value;

            // æµ‡æ°´é…ç½®
            const lastWatered = document.getElementById('lastWatered').value;
            const waterCycle = document.getElementById('waterCycle').value;

            // æ–½è‚¥é…ç½® (å¤„ç†ç©ºå€¼)
            const lastFertilized = document.getElementById('lastFertilized').value;
            const fertilizeCycle = document.getElementById('fertilizeCycle').value;

            // æ„é€ ç¬¦åˆåç«¯ PlantCreate Schema çš„æ•°æ®
            const payload = {
                nickname: nickname,
                species: species,
                // ç¡®ä¿æ•°å­—æ˜¯æ•°å­—ç±»å‹
                water_cycle: parseInt(waterCycle) || 7,
                fertilize_cycle: parseInt(fertilizeCycle) || 30,

                // æ—¥æœŸå¦‚æœæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¼  null ç»™åç«¯
                last_watered: lastWatered || null,
                last_fertilized: lastFertilized || null,

                // æ·»åŠ å¤´åƒURLï¼ˆå¦‚æœå·²ä¸Šä¼ ï¼‰
                plantAvatar_url: uploadedAvatarUrl || null
            };

            createPlant(payload);
        });

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = userPlantsCache.filter(p =>
                p.nickname.toLowerCase().includes(keyword) ||
                p.species.toLowerCase().includes(keyword)
            );
            renderPlantList(filtered);
            document.getElementById('clearSearch').style.display = keyword ? 'block' : 'none';
        });

        document.getElementById('clearSearch').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            renderPlantList(userPlantsCache);
            document.getElementById('clearSearch').style.display = 'none';
        });

        // å¼¹çª—æ§åˆ¶
        function showAddPlantModal() {
            // æ‰“å¼€æ—¶é‡ç½®è¡¨å•
            resetAddForm();
            document.getElementById('addPlantModal').style.display = 'flex';
        }

        function hideAddPlantModal() {
            document.getElementById('addPlantModal').style.display = 'none';
        }

        function showPlantDetail(id) {
            const plant = userPlantsCache.find(p => p.id === id);
            if(!plant) return;

            // å¦‚æœæœ‰å¤´åƒURLåˆ™ä½¿ç”¨
            let imgContent = '<div class="plant-detail-img bg-green-100 flex items-center justify-center text-6xl">ğŸŒ±</div>';
            if (plant.plantAvatar_url) {
                imgContent = `<img src="${API_BASE_URL.replace('/api/v1', '')}${plant.plantAvatar_url}" alt="${plant.nickname}" class="plant-detail-img">`;
            }

            const content = document.getElementById('plantDetailContent');
            content.innerHTML = `
                ${imgContent}
                <div class="plant-detail-info">
                    <div class="plant-detail-name">${plant.nickname}</div>
                    <div class="plant-detail-species">å“ç§ï¼š${plant.species}</div>

                    <div class="grid grid-cols-2 gap-4 mt-4 text-left px-4">
                        <div>
                            <p class="text-xs text-gray-500">ä¸Šæ¬¡æµ‡æ°´</p>
                            <p class="text-sm font-medium">${plant.last_watered || 'æš‚æ— '}</p>
                            <p class="text-xs text-green-600 mt-1">å‘¨æœŸ: ${plant.water_cycle}å¤©</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">ä¸Šæ¬¡æ–½è‚¥</p>
                            <p class="text-sm font-medium">${plant.last_fertilized || 'æš‚æ— '}</p>
                            <p class="text-xs text-orange-600 mt-1">å‘¨æœŸ: ${plant.fertilize_cycle || 30}å¤©</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('plantDetailModal').style.display = 'flex';
        }

        function hidePlantDetailModal() {
            document.getElementById('plantDetailModal').style.display = 'none';
        }

        // çƒ­é—¨æ¤ç‰©ç›¸å…³
        function showPopularPlantDetail(key) {
            currentPopularPlant = popularPlantsData[key];
            const content = document.getElementById('popularPlantDetailContent');
            content.innerHTML = `
                <div class="popular-plant-detail-info">
                    <div class="popular-plant-detail-name text-xl font-bold mb-2">${currentPopularPlant.name}</div>
                    <p class="text-sm text-gray-600 mb-2">${currentPopularPlant.description}</p>
                    <p class="text-sm text-green-600">ğŸ’¡ å…»æŠ¤è´´å£«ï¼š${currentPopularPlant.careTips}</p>
                </div>
            `;
            document.getElementById('popularPlantDetailModal').style.display = 'flex';
        }

        function hidePopularPlantDetailModal() {
            document.getElementById('popularPlantDetailModal').style.display = 'none';
        }

        // 4. è·å– AI å…»æŠ¤å»ºè®®
        async function fetchAIRecommendation(species) {
            if (!species || species === 'å…¶ä»–') return;

            const waterInput = document.getElementById('waterCycle');
            const fertilizeInput = document.getElementById('fertilizeCycle');

            // UI äº¤äº’ï¼šæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆæ¯”å¦‚å˜ç°æˆ–è€…æ˜¾ç¤ºloadingæ–‡å­—ï¼‰
            const originalWaterPlaceholder = waterInput.placeholder;
            waterInput.value = '';
            waterInput.placeholder = 'AIè®¡ç®—ä¸­...';
            fertilizeInput.value = '';
            fertilizeInput.placeholder = 'AIè®¡ç®—ä¸­...';

            const headers = getAuthHeaders();

            try {
                const res = await fetch(`${API_BASE_URL}/plants/recommend`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ species: species })
                });
                const data = await res.json();

                if (data.code === 200) {
                    // è‡ªåŠ¨å¡«å……ï¼Œç”¨æˆ·ä¾ç„¶å¯ä»¥ä¿®æ”¹
                    waterInput.value = data.data.water_cycle;
                    fertilizeInput.value = data.data.fertilize_cycle;

                    // ç»™ä¸€ä¸ªå°æç¤ºï¼ˆå¯é€‰ï¼‰
                    showUploadStatus(`AIå·²æ ¹æ®ã€${species}ã€‘ä¸ºæ‚¨æ¨èå…»æŠ¤å‘¨æœŸ`, 'success');
                }
            } catch (err) {
                console.error("è·å–æ¨èå¤±è´¥", err);
                waterInput.value = 7; // å¤±è´¥å›é€€é»˜è®¤å€¼
                fertilizeInput.value = 30;
            } finally {
                waterInput.placeholder = originalWaterPlaceholder || '';
                fertilizeInput.placeholder = '';
            }
        }

        function addThisPlant() {
            if(currentPopularPlant) {
                // è®¾ç½®é»˜è®¤æ˜µç§°å’Œå“ç§
                const speciesSelect = document.getElementById('plantSpecies');

                // æ£€æŸ¥ä¸‹æ‹‰æ¡†é‡Œæœ‰æ²¡æœ‰è¿™ä¸ªå“ç§ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæš‚æ—¶é€‰â€œå…¶ä»–â€æˆ–è€…æ‰‹åŠ¨æ·»åŠ optionï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾çƒ­é—¨æ¤ç‰©éƒ½åœ¨ä¸‹æ‹‰æ¡†é‡Œï¼Œæˆ–è€…ç›´æ¥å¡«å…¥ï¼‰
                // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾çƒ­é—¨æ¤ç‰©åç§°èƒ½åŒ¹é…ä¸‹æ‹‰æ¡†çš„ value
                speciesSelect.value = currentPopularPlant.name;

                // å¦‚æœä¸‹æ‹‰æ¡†é‡Œæ²¡æœ‰è¿™ä¸ªå€¼ï¼ŒspeciesSelect.value ä¼šæ˜¯ç©ºã€‚
                // è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ˜µç§°å¡«å¥½ï¼Œå“ç§ç•™ç»™ç”¨æˆ·é€‰ï¼Œæˆ–è€…å¼ºåˆ¶æ”¹ä¸ºâ€œå…¶ä»–â€
                if (!speciesSelect.value) {
                     speciesSelect.value = 'å…¶ä»–';
                }

                document.getElementById('plantNickname').value = currentPopularPlant.name + '01';

                hidePopularPlantDetailModal();
                showAddPlantModal();

                // è‡ªåŠ¨è§¦å‘ä¸€æ¬¡æ¨è
                if (speciesSelect.value !== 'å…¶ä»–') {
                    fetchAIRecommendation(speciesSelect.value);
                }
            }
        }
        // ç›‘å¬å“ç§å˜åŒ–ï¼Œè§¦å‘ AI æ¨è
        document.getElementById('plantSpecies').addEventListener('change', (e) => {
            const species = e.target.value;
            // å¦‚æœç”¨æˆ·é€‰äº†â€œå…¶ä»–â€ï¼Œæˆ–è€…æ˜¯ç©ºï¼Œå°±ä¸è§¦å‘
            if (species && species !== 'å…¶ä»–') {
                fetchAIRecommendation(species);
            }
        });
    </script>
</body>
</html>